import{B as x,F as B,G as S,H as U,o as F,I as N,J as P,K as G,L as K,q as T,D as w}from"./element-plus-vendor-BSOUQG5-.js";import{r as y,c as q,x as $,v as z,m as g,o as _,s as u,G as k,H,ac as O,P as E,Q as A,M as s,u as W,O as R,z as j,K as i,a6 as I}from"./vue-vendor-DB0sj3qF.js";import{_ as D,L as J,e as Q,f as X}from"./index-aJYRJ_fd.js";import"./utils-vendor-D8rVyQy1.js";const Z={class:"dynamics-viewer"},ee={class:"image-container"},ae={key:0,class:"loading-overlay"},le=["src","alt","onClick","onLoad"],te={class:"image-date-label"},se={key:0,class:"empty-state"},oe=["src"],ne={class:"image-date"},re={__name:"DynamicsAnalysisViewer",props:{images:{type:Array,required:!0}},setup(h){const e=h,c=y(null),d=y(1),n=y([]),p=q(()=>!e.images||e.images.length===0?1:Math.ceil(e.images.length/2)),M=a=>new Promise((t,r)=>{const m=new Image;m.onload=()=>t(),m.onerror=r,m.src=a}),V=()=>{!e.images||e.images.length===0||e.images.forEach((a,t)=>{M(a.path).then(()=>{n.value[t]=!1}).catch(r=>{console.error(`Failed to load image: ${a.path}`,r),n.value[t]=!1})})};$(()=>e.images,a=>{a&&a.length>0&&(n.value=new Array(a.length).fill(!0),V())},{immediate:!0});const o=a=>{n.value[a]=!1},l=a=>{a&&(c.value=a,d.value=1)},f=a=>{const t=Math.sign(a.deltaY),r=Math.max(1,Math.min(3,d.value-t*.2));d.value=r,a.preventDefault()};return z(()=>{V()}),(a,t)=>(_(),g("div",Z,[t[4]||(t[4]=u("h2",{class:"section-title"},"动力学分析结果热图",-1)),u("div",{class:"image-grid",style:A({"--images-per-row":p.value})},[(_(!0),g(H,null,O(h.images,(r,m)=>(_(),g("div",{key:m,class:"image-card"},[u("div",ee,[n.value[m]?(_(),g("div",ae,t[2]||(t[2]=[u("div",{class:"loading-spinner"},null,-1)]))):k("",!0),u("img",{src:r.path,alt:`${r.date} - 动力学分析结果`,class:"analysis-image",onClick:b=>l(r),onLoad:b=>o(m)},null,40,le)]),u("div",te,E(r.date),1)]))),128))],4),!h.images||h.images.length===0?(_(),g("div",se,[s(W(x),{description:"暂无分析结果"})])):k("",!0),c.value?(_(),g("div",{key:1,class:"modal-overlay",onWheel:f,onClick:t[1]||(t[1]=R(r=>c.value=null,["self"]))},[u("div",{class:"modal-content",style:A({transform:`scale(${d.value})`})},[u("img",{src:c.value.path,alt:"放大查看",class:"modal-image"},null,8,oe),u("p",ne,E(c.value.date),1)],4),u("button",{onClick:t[0]||(t[0]=r=>c.value=null),class:"close-button"},t[3]||(t[3]=[u("svg",{class:"close-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[u("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]))],32)):k("",!0)]))}},ue=D(re,[["__scopeId","data-v-25b0c470"]]),ie={class:"container-layout"},de={class:"main-content"},me={key:0,class:"loading-container"},ce={key:1,class:"result-section"},ve={__name:"DynamicsAnalysisView",setup(h){const e=y({dataRange:[],grad_forecast_month:1,grad_month:"",grad_lat_lon:"",grad_type:"sum"}),c=y([]),d=y(!1),n=y(!1),p=y(null);$([()=>e.value.dataRange,()=>e.value.grad_forecast_month],([o,l])=>{if(o&&o[1]&&l){const f=new Date(o[1].substring(0,4),parseInt(o[1].substring(4))-1);f.setMonth(f.getMonth()+l),e.value.grad_month=String(f.getMonth()+1).padStart(2,"0")}else e.value.grad_month=""});const M=async()=>{if(p.value)try{const o=await X(p.value);o.length!==0&&(c.value=o,d.value=!0,w.success("分析完成"),n.value=!1,p.value=null)}catch(o){if(o.response&&o.response.status===400){console.log("Task not completed yet, continuing polling...");return}console.error("轮询分析结果出错:",o),n.value=!1,d.value=!1,w.error("获取分析结果失败")}},V=async()=>{if(!e.value.dataRange||!e.value.dataRange[0]||!e.value.dataRange[1]||!e.value.grad_month||!e.value.grad_forecast_month){w.error("请填写完整的分析参数");return}try{n.value=!0,d.value=!1;const o=await Q(e.value.dataRange[0],e.value.dataRange[1],e.value.grad_type,e.value.grad_month);p.value=o.task_id;const l=setInterval(async()=>{await M(),n.value||clearInterval(l)},2e3)}catch(o){d.value=!1,n.value=!1,w.error("提交分析请求失败，请重试"),console.error("Analysis error:",o)}};return j(()=>{p.value&&(p.value=null)}),(o,l)=>{const f=F,a=U,t=N,r=P,m=K,b=G,C=T,L=S,Y=B;return _(),g("div",ie,[u("div",de,[s(Y,{class:"box-card"},{default:i(()=>[s(L,{model:e.value,onSubmit:R(V,["prevent"]),class:"analysis-form"},{default:i(()=>[s(a,{label:"数据范围"},{default:i(()=>[s(f,{modelValue:e.value.dataRange,"onUpdate:modelValue":l[0]||(l[0]=v=>e.value.dataRange=v),type:"monthrange","range-separator":"至","start-placeholder":"开始月份","end-placeholder":"结束月份",format:"YYYY-MM","value-format":"YYYYMM"},null,8,["modelValue"])]),_:1}),s(a,{label:"预报提前期"},{default:i(()=>[s(t,{modelValue:e.value.grad_forecast_month,"onUpdate:modelValue":l[1]||(l[1]=v=>e.value.grad_forecast_month=v),min:1,placeholder:"请输入提前期（月）"},null,8,["modelValue"])]),_:1}),s(a,{label:"目标月份"},{default:i(()=>[s(f,{modelValue:e.value.grad_month,"onUpdate:modelValue":l[2]||(l[2]=v=>e.value.grad_month=v),type:"month",placeholder:"目标月份由数据范围和预报提前期决定",format:"MM","value-format":"MM",disabled:""},null,8,["modelValue"])]),_:1}),s(a,{label:"分析范围"},{default:i(()=>[s(r,{modelValue:e.value.grad_lat_lon,"onUpdate:modelValue":l[3]||(l[3]=v=>e.value.grad_lat_lon=v),disabled:"",placeholder:"请输入经纬度范围（目前只支持全范围）"},null,8,["modelValue"])]),_:1}),s(a,{label:"分析目标"},{default:i(()=>[s(b,{modelValue:e.value.grad_type,"onUpdate:modelValue":l[4]||(l[4]=v=>e.value.grad_type=v)},{default:i(()=>[s(m,{value:"sum"},{default:i(()=>l[5]||(l[5]=[I("海冰面积")])),_:1}),s(m,{value:"variation"},{default:i(()=>l[6]||(l[6]=[I("海冰变化")])),_:1})]),_:1},8,["modelValue"])]),_:1}),s(a,null,{default:i(()=>[s(C,{type:"primary",loading:n.value,onClick:V},{default:i(()=>[I(E(n.value?"分析中...":"提交分析"),1)]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"]),n.value?(_(),g("div",me,[s(J)])):k("",!0),!n.value&&d.value?(_(),g("div",ce,[s(ue,{images:c.value,class:"full-width"},null,8,["images"])])):k("",!0)]),_:1})])])}}},ye=D(ve,[["__scopeId","data-v-312fdcea"]]);export{ye as default};
