import{_ as A,r as c,C as N,U as Y,o as F,c as f,b as _,D as i,E as b,ap as P,aq as B,e as I,H as D,M as L,a as s,as as C,aJ as O,w as u,aE as E,L as T,aI as y,aK as q,aL as G}from"./index-CPnqO15T.js";import{E as K,a as W,b as j,c as z,I as H,d as J,e as Q}from"./ImageSelector-jZ5nrWTB.js";import{g as x,d as X,E as Z,c as ee}from"./util-CxsDoqGQ.js";const ae={class:"dynamics-viewer"},le={class:"image-container"},te={key:0,class:"loading-overlay"},se=["src","alt","onClick","onLoad"],oe={class:"image-date-label"},ne={key:0,class:"empty-state"},re=["src"],ue={class:"image-date"},ie={__name:"DynamicsAnalysisViewer",props:{images:{type:Array,required:!0}},setup(h){const a=h,v=c(null),d=c(1),n=c([]),m=N(()=>!a.images||a.images.length===0?1:Math.ceil(a.images.length/2)),M=e=>new Promise((t,o)=>{const g=new Image;g.onload=()=>t(),g.onerror=o,g.src=e}),p=()=>{!a.images||a.images.length===0||a.images.forEach((e,t)=>{M(x(e.path)).then(()=>{n.value[t]=!1}).catch(o=>{console.error(`Failed to load image: ${e.path}`,o),n.value[t]=!1})})};Y(()=>a.images,e=>{e&&e.length>0&&(n.value=new Array(e.length).fill(!0),p())},{immediate:!0});const w=e=>{n.value[e]=!1},V=e=>{e&&(v.value=e,d.value=1)},l=e=>{const t=Math.sign(e.deltaY),o=Math.max(1,Math.min(3,d.value-t*.2));d.value=o,e.preventDefault()};return F(()=>{p()}),(e,t)=>(_(),f("div",ae,[t[4]||(t[4]=i("h2",{class:"section-title"},"动力学分析结果热图",-1)),i("div",{class:"image-grid",style:L({"--images-per-row":m.value})},[(_(!0),f(P,null,B(h.images,(o,g)=>(_(),f("div",{key:g,class:"image-card"},[i("div",le,[n.value[g]?(_(),f("div",te,t[2]||(t[2]=[i("div",{class:"loading-spinner"},null,-1)]))):b("",!0),i("img",{src:I(x)(o.path),alt:`${o.date} - 动力学分析结果`,class:"analysis-image",onClick:k=>V(o),onLoad:k=>w(g)},null,40,se)]),i("div",oe,D(o.date),1)]))),128))],4),!h.images||h.images.length===0?(_(),f("div",ne,[s(I(X),{description:"暂无分析结果"})])):b("",!0),v.value?(_(),f("div",{key:1,class:"modal-overlay",onWheel:l,onClick:t[1]||(t[1]=C(o=>v.value=null,["self"]))},[i("div",{class:"modal-content",style:L({transform:`scale(${d.value})`})},[i("img",{src:I(x)(v.value.path),alt:"放大查看",class:"modal-image"},null,8,re),i("p",ue,D(v.value.date),1)],4),i("button",{onClick:t[0]||(t[0]=o=>v.value=null),class:"close-button"},t[3]||(t[3]=[i("svg",{class:"close-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[i("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]))],32)):b("",!0)]))}},de=A(ie,[["__scopeId","data-v-e77b7c64"]]),me={class:"container-layout"},ce={key:0,class:"loading-container"},ve={key:1,class:"result-section"},ge={__name:"DynamicsAnalysisView",setup(h){const a=c({startMonth:"",endMonth:"",grad_forecast_month:1,grad_month:"",grad_lat_lon:"",grad_type:"sum",x1:null,y1:null,x2:null,y2:null}),v=c([]),d=c(!1),n=c(!1),m=c(null),M=c({x:null,y:null}),p=c({x:null,y:null});Y([M,p],([l,e])=>{a.value.x1=l.y,a.value.y1=l.x,a.value.x2=e.y,a.value.y2=e.x},{immediate:!0,deep:!0}),Y([()=>a.value.endMonth,()=>a.value.grad_forecast_month],([l,e])=>{if(l&&e){const t=new Date(l.substring(0,4),parseInt(l.substring(4))-1);t.setMonth(t.getMonth()+e),a.value.grad_month=String(t.getMonth()+1).padStart(2,"0")}else a.value.grad_month=""});const w=async()=>{if(m.value)try{const l=await G(m.value);l.success&&l.status==="COMPLETED"?(v.value=l.data.images,d.value=!0,y.success(l.message||"分析完成"),n.value=!1,m.value=null):l.status==="IN_PROGRESS"?console.log("Task not completed yet, continuing polling..."):l.status==="FAILED"&&(console.error("分析任务失败:",l.message),n.value=!1,d.value=!1,y.error(l.message||"分析任务失败"),m.value=null)}catch(l){console.error("轮询分析结果出错:",l),n.value=!1,d.value=!1,y.error("获取分析结果失败"),m.value=null}},V=async()=>{if(!a.value.startMonth||!a.value.endMonth||!a.value.grad_month||!a.value.grad_forecast_month){y.error("请填写完整的分析参数");return}try{n.value=!0,d.value=!1;const l=await q(a.value.startMonth,a.value.endMonth,a.value.grad_type,a.value.grad_month,a.value.x1,a.value.y1,a.value.x2,a.value.y2);if(l.success)m.value=l.data.task_id;else{n.value=!1,y.error(l.message||"提交分析请求失败");return}const e=setInterval(async()=>{await w(),n.value||clearInterval(e)},2e3)}catch(l){d.value=!1,n.value=!1,y.error("提交分析请求失败，请重试"),console.error("Analysis error:",l)}};return O(()=>{m.value&&(m.value=null)}),(l,e)=>{const t=Z,o=j,g=z,k=Q,$=J,R=ee,U=W,S=K;return _(),f("div",me,[s(S,{class:"box-card"},{default:u(()=>[s(U,{model:a.value,onSubmit:C(V,["prevent"]),class:"analysis-form"},{default:u(()=>[s(o,{label:"开始月份"},{default:u(()=>[s(t,{modelValue:a.value.startMonth,"onUpdate:modelValue":e[0]||(e[0]=r=>a.value.startMonth=r),type:"month",placeholder:"选择开始月份",format:"YYYY-MM","value-format":"YYYYMM"},null,8,["modelValue"])]),_:1}),s(o,{label:"结束月份"},{default:u(()=>[s(t,{modelValue:a.value.endMonth,"onUpdate:modelValue":e[1]||(e[1]=r=>a.value.endMonth=r),type:"month",placeholder:"选择结束月份",format:"YYYY-MM","value-format":"YYYYMM"},null,8,["modelValue"])]),_:1}),s(o,{label:"预报提前期"},{default:u(()=>[s(g,{modelValue:a.value.grad_forecast_month,"onUpdate:modelValue":e[2]||(e[2]=r=>a.value.grad_forecast_month=r),min:1,placeholder:"请输入提前期（月）"},null,8,["modelValue"])]),_:1}),s(o,{label:"目标月份"},{default:u(()=>[s(t,{modelValue:a.value.grad_month,"onUpdate:modelValue":e[3]||(e[3]=r=>a.value.grad_month=r),type:"month",placeholder:"目标月份由数据范围和预报提前期决定",format:"MM","value-format":"MM",disabled:""},null,8,["modelValue"])]),_:1}),s(o,{label:"分析范围"},{default:u(()=>[s(H,{topLeft:M.value,"onUpdate:topLeft":e[4]||(e[4]=r=>M.value=r),bottomRight:p.value,"onUpdate:bottomRight":e[5]||(e[5]=r=>p.value=r)},null,8,["topLeft","bottomRight"])]),_:1}),s(o,{label:"分析目标"},{default:u(()=>[s($,{modelValue:a.value.grad_type,"onUpdate:modelValue":e[6]||(e[6]=r=>a.value.grad_type=r)},{default:u(()=>[s(k,{value:"sum"},{default:u(()=>e[7]||(e[7]=[E("海冰面积")])),_:1}),s(k,{value:"variation"},{default:u(()=>e[8]||(e[8]=[E("海冰变化")])),_:1})]),_:1},8,["modelValue"])]),_:1}),s(o,null,{default:u(()=>[s(R,{type:"primary",loading:n.value,onClick:V},{default:u(()=>[E(D(n.value?"分析中...":"提交分析"),1)]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"]),n.value?(_(),f("div",ce,[s(T)])):b("",!0),!n.value&&d.value?(_(),f("div",ve,[s(de,{images:v.value,class:"full-width"},null,8,["images"])])):b("",!0)]),_:1})])}}},ye=A(ge,[["__scopeId","data-v-92377546"]]);export{ye as default};
