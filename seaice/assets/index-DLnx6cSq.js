import{d as te,r as g,_ as q,x as G,e as w,i as _,c as V,o as k,a as c,h as n,j as d,n as Y,y as Z,z as ae,T as le,p as ne,q as oe,u,m as W,F,l as O,k as j,t as E}from"./index-Ds_D5mJM.js";import{b as se,u as ie}from"./index-D6yiuLGm.js";const re=te("modelInterpreter",()=>{const L=g([]),m=g([]);function r(t){for(;t.value.length>3;)t.value.splice(3)}function o(t){L.value.unshift(t),T({status:"处理中",task_id:t.task_id,timeId:null}),e(m.value[0]),r(L)}function T(t){m.value.unshift(t),r(m)}function e(t,p=2e3){t.timerId==null&&(t.timerId=setInterval(async()=>{try{const M=await se(t.task_id);console.log("response",M),(M.status==="COMPLETED"||M.status==="FAILED")&&(t.status=M.status==="COMPLETED"?"完成":"失败",t.images=M.data.images,clearInterval(t.timerId),t.timerId=null)}catch(M){console.error("Error polling task status:",M)}},p))}function h(){for(const t of m.value)t.status!=="完成"&&t.status!=="失败"&&e(t)}function f(){for(const t of m.value)t.timerId&&(clearInterval(t.timerId),t.timerId=null)}return{taskList:L,addTask:o,resultList:m,addResult:T,pollTaskStatus:e,clearAllTimers:f,pollAllTaskStatus:h}},{persist:{enabled:!0,strategies:[{key:"modelInterpreter",storage:localStorage,paths:["taskList","resultList"]}]}}),ue={class:"image-selector-container"},ce={class:"info-area"},de=["src"],me={__name:"index",props:{imageUrl:{type:String,required:!0}},emits:["selection-string"],setup(U,{emit:L}){const m=L,r=g(null),o=g(null),T=g(!1),e=G({active:!1,x:0,y:0,width:0,height:0,startX:0,startY:0}),h=g(0),f=g(0),t=g(0),p=g(0),M=()=>{if(r.value){const s=r.value.getBoundingClientRect();s.left,s.top}o.value&&(h.value=Math.round(o.value.clientHeight||o.value.naturalHeight||0),f.value=Math.round(o.value.clientWidth||o.value.naturalWidth||0),t.value=o.value.naturalWidth||0,p.value=o.value.naturalHeight||0)},A=s=>{if(!r.value)return;T.value=!0,e.active=!0;const i=r.value.getBoundingClientRect();e.startX=Math.round(s.pageX-i.left-window.scrollX),e.startY=Math.round(s.pageY-i.top-window.scrollY),e.x=e.startX,e.y=e.startY,e.width=0,e.height=0},R=s=>{if(!T.value)return;const i=r.value.getBoundingClientRect(),y=s.pageX-i.left-window.scrollX,x=s.pageY-i.top-window.scrollY;y<e.startX?(e.x=Math.round(y),e.width=Math.round(e.startX-y)):(e.x=Math.round(e.startX),e.width=Math.round(y-e.startX)),x<e.startY?(e.y=Math.round(x),e.height=Math.round(e.startY-x)):(e.y=Math.round(e.startY),e.height=Math.round(x-e.startY))},D=()=>{T.value=!1,e.width===0&&e.height===0?B():b()},B=()=>{e.active=!1,e.width=f.value||t.value||0,e.height=h.value||p.value||0,e.x=0,e.y=0,b()},H=w(()=>({left:`${e.x}px`,top:`${e.y}px`,width:`${e.width}px`,height:`${e.height}px`}));w(()=>({x:Math.round(e.x+e.width),y:Math.round(e.y)})),w(()=>({x:Math.round(e.x),y:Math.round(e.y+e.height)})),w(()=>({x:Math.round(e.x+e.width),y:Math.round(e.y+e.height)}));const X=w(()=>t.value>0?304/t.value:1),S=w(()=>p.value>0?448/p.value:1),l=w(()=>{const s=f.value>0?e.x/f.value*t.value:e.x,i=h.value>0?e.y/h.value*p.value:e.y;return{x:Math.round(s*X.value),y:Math.round((p.value-i)*S.value)}}),a=w(()=>{const s=f.value>0?(e.x+e.width)/f.value*t.value:e.x+e.width,i=h.value>0?e.y/h.value*p.value:e.y;return{x:Math.round(s*X.value),y:Math.round((p.value-i)*S.value)}}),C=w(()=>{const s=f.value>0?e.x/f.value*t.value:e.x,i=h.value>0?(e.y+e.height)/h.value*p.value:e.y+e.height;return{x:Math.round(s*X.value),y:Math.round((p.value-i)*S.value)}}),I=w(()=>{const s=f.value>0?(e.x+e.width)/f.value*t.value:e.x+e.width,i=h.value>0?(e.y+e.height)/h.value*p.value:e.y+e.height;return{x:Math.round(s*X.value),y:Math.round((p.value-i)*S.value)}}),z=w(()=>{const s=C.value,i=l.value,y=I.value,x=a.value;return{bl:s,tl:i,br:y,tr:x}});function b(){m("selection-string",z.value)}return(s,i)=>{const y=_("b-button"),x=_("vue-fontawesome"),N=_("b-tooltip");return k(),V("div",ue,[c("div",ce,[n(y,{onClick:B,size:"is-small"},{default:d(()=>[...i[0]||(i[0]=[Y("清除选择",-1)])]),_:1}),n(N,{style:{margin:"0 5px","line-height":"30px"},label:"默认选择整张图片",position:"is-right",type:"is-dark"},{default:d(()=>[n(x,{icon:"circle-exclamation"})]),_:1})]),c("div",{class:"image-area",ref_key:"imageAreaRef",ref:r,onMousedown:A,onMousemove:R,onMouseup:D,onMouseleave:D},[c("img",{ref_key:"imageRef",ref:o,src:U.imageUrl,alt:"Selectable Image",onLoad:M},null,40,de),e.active?(k(),V("div",{key:0,class:"selection-box",style:ae(H.value)},null,4)):Z("",!0)],544)])}}},ve=q(me,[["__scopeId","data-v-05babb4b"]]),pe="/seaice/assets/result_mask-B-CZuruY.png",_e=new le,ge=U=>{_e.open({message:U,duration:2e3,queue:!0})},he={class:"modelInterpreterContainer"},fe={class:"formContainer"},be=["value"],ye={class:"resultContainer"},xe={class:"resultList"},Me={class:"taskId"},we={class:"idBox"},ke={class:"tag"},Ie=["onClick"],Se={key:0,class:"iconBox"},Ve={key:1,class:"iconBox"},Le={class:"createdTime"},Te={class:"modalBox"},$e={class:"content"},De=["src","onClick"],Xe=["src"],Ce="images/arctic_mask.webp",Ye={__name:"index",setup(U){const L="https://seaice.52lxy.one:20443",m=re(),r=g([null,null]),o=G({start_time:"",end_time:"",pred_gap:1,grad_type:"sum",variable:"",position:""}),T=new Date(1979,0,1),e=new Date(2023,11,31),h=[{label:"海冰密集度(SIC)",value:"1"},{label:"海冰U分量(SI_U)",value:"2"},{label:"海冰V分量(SI_V)",value:"3"},{label:"2米温度(T2M)",value:"4"},{label:"10米U风(U10M)",value:"5"},{label:"10米V风(V10M)",value:"6"}],f=l=>{o.variable=l},t=g(""),p=l=>{const a=l?new Date(l):null;if(t.value="",!a){r.value[0]=null;return}r.value[0]=a.getTime()},M=l=>{const a=r.value&&r.value[0]?r.value[0]:null,C=a?typeof a=="number"?new Date(a):new Date(a):null,I=l?new Date(l):null;if(!C||!I)return;if(Math.ceil((I-C)/(1e3*60*60*24))>=14){const b=s=>{const i=s.getFullYear(),y=String(s.getMonth()+1).padStart(2,"0"),x=String(s.getDate()).padStart(2,"0");return`${i}${y}${x}`};r.value=[b(C),b(I)],o.start_time=r.value[0],o.end_time=r.value[1],console.log("dateRange.value",r.value),t.value=""}else t.value="选择范围不足14天，未保存。",r.value=[null,null],o.start_time="",o.end_time=""},A=l=>{o.position=`${l.bl.y},${l.bl.x};${l.tl.y},${l.tl.x};${l.br.y},${l.br.x};${l.tr.y},${l.tr.x}`,console.log("form.position",o.position)},R=()=>{t.value||r.value[0]===null||r.value[1]===null||ie(o).then(l=>{ge(l.message);let a=l.data||{};a.status=l.status||"",a.created_time=new Date().toLocaleString(),m.addTask(a)}).catch(l=>{console.error("Error in Model Interpreter:",l)})},D=g(!1),B=g(null),H=l=>{m.resultList[l].status==="完成"&&(D.value=!0,B.value=l)},X=g(null),S=g(!1);return ne(()=>{m.pollAllTaskStatus()}),oe(()=>{m.clearAllTimers()}),(l,a)=>{const C=_("b-datepicker"),I=_("vue-fontawesome"),z=_("b-tooltip"),b=_("b-field"),s=_("b-numberinput"),i=_("b-radio"),y=ve,x=_("b-select"),N=_("b-button"),J=_("b-message"),K=_("b-tag"),Q=_("b-notification"),P=_("b-modal");return k(),V("div",he,[c("div",fe,[c("section",null,[n(b,{label:"数据范围",horizontal:"",class:"datepickerBox",type:u(t)?"is-danger":"",message:u(t)},{default:d(()=>[n(C,{placeholder:"点击选择...",range:"",style:{width:"230px"},size:"is-small","min-date":u(T),"max-date":u(e),onRangeEnd:M,onRangeStart:p},null,8,["min-date","max-date"]),n(z,{style:{margin:"0 10px","line-height":"30px"},label:"日期有效范围为1979-2023,前后范围最短为14天",position:"is-right",type:"is-dark"},{default:d(()=>[n(I,{icon:"circle-exclamation"})]),_:1})]),_:1},8,["type","message"]),n(b,{label:"预测间隔",horizontal:""},{default:d(()=>[n(s,{size:"is-small",type:"is-dark",modelValue:u(o).pred_gap,"onUpdate:modelValue":a[0]||(a[0]=v=>u(o).pred_gap=v),modelModifiers:{number:!0},min:"1",style:{width:"230px",height:"30px"}},null,8,["modelValue"]),a[5]||(a[5]=c("span",{style:{"font-weight":"bold","line-height":"30px"}},"天",-1))]),_:1}),n(b,{label:"分析目标",horizontal:"",class:"gradType"},{default:d(()=>[n(i,{modelValue:u(o).grad_type,"onUpdate:modelValue":a[1]||(a[1]=v=>u(o).grad_type=v),name:"analysisObjective","native-value":"sum",type:"is-black"},{default:d(()=>[...a[6]||(a[6]=[Y(" 均值 ",-1)])]),_:1},8,["modelValue"]),n(i,{modelValue:u(o).grad_type,"onUpdate:modelValue":a[2]||(a[2]=v=>u(o).grad_type=v),name:"analysisObjective","native-value":"l2",type:"is-black"},{default:d(()=>[...a[7]||(a[7]=[Y(" 分布 ",-1)])]),_:1},8,["modelValue"])]),_:1}),n(b,{label:"选定位置",horizontal:""},{default:d(()=>[n(y,{"image-url":Ce,onSelectionString:A})]),_:1}),n(b,{label:"选定变量",horizontal:""},{default:d(()=>[n(x,{placeholder:"选择一个变量",size:"is-small","onUpdate:modelValue":f},{default:d(()=>[(k(),V(F,null,O(h,(v,$)=>c("option",{value:v.value,key:$},E(v.label),9,be)),64))]),_:1})]),_:1}),n(b,{horizontal:""},{default:d(()=>[n(N,{type:"is-dark",size:"is-small",style:{margin:"10px 0"},onClick:R},{default:d(()=>[...a[8]||(a[8]=[Y("提交分析",-1)])]),_:1})]),_:1})])]),c("div",ye,[c("section",null,[n(b,{label:"逐日模型可解释性分析结果热图",horizontal:""},{default:d(()=>[n(z,{label:"缓存最近三条分析记录",position:"is-bottom",type:"is-dark"},{default:d(()=>[n(I,{icon:"circle-exclamation"})]),_:1})]),_:1}),u(m).taskList.length==0?(k(),W(J,{key:0},{default:d(()=>[...a[9]||(a[9]=[Y(" 提交分析之后才会显示结果热图! ",-1)])]),_:1})):Z("",!0)]),c("section",xe,[(k(!0),V(F,null,O(u(m).taskList,(v,$)=>(k(),W(Q,{closable:!1,key:v.task_id},{default:d(()=>[c("div",Me,[c("span",we," 任务id: "+E(v.task_id),1),c("span",ke,[n(K,{type:u(m).resultList[$].status==="完成"?"is-success is-light":"is-warning is-light"},{default:d(()=>[Y(E(u(m).resultList[$].status),1)]),_:2},1032,["type"])])]),c("div",{class:"resultMask",onClick:ee=>H($)},[a[10]||(a[10]=c("img",{src:pe,alt:""},null,-1)),u(m).resultList[$].status==="完成"?(k(),V("span",Se,[n(I,{class:"eyeIcon",icon:"eye"})])):(k(),V("span",Ve,[n(I,{class:"eyeIcon",icon:"eye-slash"})]))],8,Ie),c("div",Le," 提交时间: "+E(v.created_time),1)]),_:2},1024))),128))])]),n(P,{modelValue:u(D),"onUpdate:modelValue":a[3]||(a[3]=v=>j(D)?D.value=v:null)},{default:d(()=>[c("div",Te,[a[11]||(a[11]=c("h3",{class:"title"},"逐日模型可解释性分析结果热图",-1)),c("div",$e,[(k(!0),V(F,null,O(u(m).resultList[u(B)].images,(v,$)=>(k(),V("li",{class:"imgItem",key:$},[c("img",{src:u(L)+v,alt:"Result Image",onClick:ee=>{X.value=v,S.value=!0}},null,8,De)]))),128))])])]),_:1},8,["modelValue"]),n(P,{modelValue:u(S),"onUpdate:modelValue":a[4]||(a[4]=v=>j(S)?S.value=v:null),class:"previewModal"},{default:d(()=>[c("div",null,[c("img",{src:u(L)+u(X),alt:"Preview Image"},null,8,Xe)])]),_:1},8,["modelValue"])])}}},ze=q(Ye,[["__scopeId","data-v-8061a84f"]]);export{ze as default};
