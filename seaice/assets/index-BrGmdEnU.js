import{d as te,r as g,_ as q,x as G,e as M,i as _,c as V,o as w,a as u,h as n,j as d,n as Y,y as Z,z as ae,T as le,p as ne,q as oe,u as r,m as W,F,l as O,k as j,t as E}from"./index-BR1so6ji.js";import{b as se,u as ie}from"./index-C7Xund2t.js";const re=te("modelInterpreter",()=>{const L=g([]),m=g([]);function c(t){for(;t.value.length>3;)t.value.splice(3)}function s(t){L.value.unshift(t),T({status:"处理中",task_id:t.task_id,timeId:null}),e(m.value[0]),c(L)}function T(t){m.value.unshift(t),c(m)}function e(t,p=2e3){t.timerId==null&&(t.timerId=setInterval(async()=>{try{const I=await se(t.task_id);(I.status==="COMPLETED"||I.status==="FAILED")&&(t.status=I.status==="COMPLETED"?"完成":"失败",t.images=I.data.images,clearInterval(t.timerId),t.timerId=null)}catch{}},p))}function h(){for(const t of m.value)t.status!=="完成"&&t.status!=="失败"&&e(t)}function f(){for(const t of m.value)t.timerId&&(clearInterval(t.timerId),t.timerId=null)}return{taskList:L,addTask:s,resultList:m,addResult:T,pollTaskStatus:e,clearAllTimers:f,pollAllTaskStatus:h}},{persist:{enabled:!0,strategies:[{key:"modelInterpreter",storage:localStorage,paths:["taskList","resultList"]}]}}),ue={class:"image-selector-container"},ce={class:"info-area"},de=["src"],me={__name:"index",props:{imageUrl:{type:String,required:!0}},emits:["selection-string"],setup(U,{emit:L}){const m=L,c=g(null),s=g(null),T=g(!1),e=G({active:!1,x:0,y:0,width:0,height:0,startX:0,startY:0}),h=g(0),f=g(0),t=g(0),p=g(0),I=()=>{if(c.value){const o=c.value.getBoundingClientRect();o.left,o.top}s.value&&(h.value=Math.round(s.value.clientHeight||s.value.naturalHeight||0),f.value=Math.round(s.value.clientWidth||s.value.naturalWidth||0),t.value=s.value.naturalWidth||0,p.value=s.value.naturalHeight||0)},A=o=>{if(!c.value)return;T.value=!0,e.active=!0;const i=c.value.getBoundingClientRect();e.startX=Math.round(o.pageX-i.left-window.scrollX),e.startY=Math.round(o.pageY-i.top-window.scrollY),e.x=e.startX,e.y=e.startY,e.width=0,e.height=0},R=o=>{if(!T.value)return;const i=c.value.getBoundingClientRect(),y=o.pageX-i.left-window.scrollX,x=o.pageY-i.top-window.scrollY;y<e.startX?(e.x=Math.round(y),e.width=Math.round(e.startX-y)):(e.x=Math.round(e.startX),e.width=Math.round(y-e.startX)),x<e.startY?(e.y=Math.round(x),e.height=Math.round(e.startY-x)):(e.y=Math.round(e.startY),e.height=Math.round(x-e.startY))},D=()=>{T.value=!1,e.width===0&&e.height===0?B():b()},B=()=>{e.active=!1,e.width=f.value||t.value||0,e.height=h.value||p.value||0,e.x=0,e.y=0,b()},H=M(()=>({left:`${e.x}px`,top:`${e.y}px`,width:`${e.width}px`,height:`${e.height}px`}));M(()=>({x:Math.round(e.x+e.width),y:Math.round(e.y)})),M(()=>({x:Math.round(e.x),y:Math.round(e.y+e.height)})),M(()=>({x:Math.round(e.x+e.width),y:Math.round(e.y+e.height)}));const X=M(()=>t.value>0?304/t.value:1),S=M(()=>p.value>0?448/p.value:1),l=M(()=>{const o=f.value>0?e.x/f.value*t.value:e.x,i=h.value>0?e.y/h.value*p.value:e.y;return{x:Math.round(o*X.value),y:Math.round((p.value-i)*S.value)}}),a=M(()=>{const o=f.value>0?(e.x+e.width)/f.value*t.value:e.x+e.width,i=h.value>0?e.y/h.value*p.value:e.y;return{x:Math.round(o*X.value),y:Math.round((p.value-i)*S.value)}}),C=M(()=>{const o=f.value>0?e.x/f.value*t.value:e.x,i=h.value>0?(e.y+e.height)/h.value*p.value:e.y+e.height;return{x:Math.round(o*X.value),y:Math.round((p.value-i)*S.value)}}),k=M(()=>{const o=f.value>0?(e.x+e.width)/f.value*t.value:e.x+e.width,i=h.value>0?(e.y+e.height)/h.value*p.value:e.y+e.height;return{x:Math.round(o*X.value),y:Math.round((p.value-i)*S.value)}}),z=M(()=>{const o=C.value,i=l.value,y=k.value,x=a.value;return{bl:o,tl:i,br:y,tr:x}});function b(){m("selection-string",z.value)}return(o,i)=>{const y=_("b-button"),x=_("vue-fontawesome"),N=_("b-tooltip");return w(),V("div",ue,[u("div",ce,[n(y,{onClick:B,size:"is-small"},{default:d(()=>[...i[0]||(i[0]=[Y("清除选择",-1)])]),_:1}),n(N,{style:{margin:"0 5px","line-height":"30px"},label:"默认选择整张图片",position:"is-right",type:"is-dark"},{default:d(()=>[n(x,{icon:"circle-exclamation"})]),_:1})]),u("div",{class:"image-area",ref_key:"imageAreaRef",ref:c,onMousedown:A,onMousemove:R,onMouseup:D,onMouseleave:D},[u("img",{ref_key:"imageRef",ref:s,src:U.imageUrl,alt:"Selectable Image",onLoad:I},null,40,de),e.active?(w(),V("div",{key:0,class:"selection-box",style:ae(H.value)},null,4)):Z("",!0)],544)])}}},ve=q(me,[["__scopeId","data-v-05babb4b"]]),pe="/seaice/assets/result_mask-B-CZuruY.png",_e=new le,ge=U=>{_e.open({message:U,duration:2e3,queue:!0})},he={class:"modelInterpreterContainer"},fe={class:"formContainer"},be=["value"],ye={class:"resultContainer"},xe={class:"resultList"},Me={class:"taskId"},we={class:"idBox"},ke={class:"tag"},Ie=["onClick"],Se={key:0,class:"iconBox"},Ve={key:1,class:"iconBox"},Le={class:"createdTime"},Te={class:"modalBox"},$e={class:"content"},De=["src","onClick"],Xe=["src"],Ce="images/arctic_mask.webp",Ye={__name:"index",setup(U){const L="https://assets.seaice.52lxy.top:20443",m=re(),c=g([null,null]),s=G({start_time:"",end_time:"",pred_gap:1,grad_type:"sum",variable:"",position:""}),T=new Date(1979,0,1),e=new Date(2023,11,31),h=[{label:"海冰密集度(SIC)",value:"1"},{label:"海冰U分量(SI_U)",value:"2"},{label:"海冰V分量(SI_V)",value:"3"},{label:"2米温度(T2M)",value:"4"},{label:"10米U风(U10M)",value:"5"},{label:"10米V风(V10M)",value:"6"}],f=l=>{s.variable=l},t=g(""),p=l=>{const a=l?new Date(l):null;if(t.value="",!a){c.value[0]=null;return}c.value[0]=a.getTime()},I=l=>{const a=c.value&&c.value[0]?c.value[0]:null,C=a?typeof a=="number"?new Date(a):new Date(a):null,k=l?new Date(l):null;if(!C||!k)return;if(Math.ceil((k-C)/(1e3*60*60*24))>=14){const b=o=>{const i=o.getFullYear(),y=String(o.getMonth()+1).padStart(2,"0"),x=String(o.getDate()).padStart(2,"0");return`${i}${y}${x}`};c.value=[b(C),b(k)],s.start_time=c.value[0],s.end_time=c.value[1],t.value=""}else t.value="选择范围不足14天，未保存。",c.value=[null,null],s.start_time="",s.end_time=""},A=l=>{s.position=`${l.bl.y},${l.bl.x};${l.tl.y},${l.tl.x};${l.br.y},${l.br.x};${l.tr.y},${l.tr.x}`},R=()=>{t.value||c.value[0]===null||c.value[1]===null||ie(s).then(l=>{ge(l.message);let a=l.data||{};a.status=l.status||"",a.created_time=new Date().toLocaleString(),m.addTask(a)}).catch(l=>{})},D=g(!1),B=g(null),H=l=>{m.resultList[l].status==="完成"&&(D.value=!0,B.value=l)},X=g(null),S=g(!1);return ne(()=>{m.pollAllTaskStatus()}),oe(()=>{m.clearAllTimers()}),(l,a)=>{const C=_("b-datepicker"),k=_("vue-fontawesome"),z=_("b-tooltip"),b=_("b-field"),o=_("b-numberinput"),i=_("b-radio"),y=ve,x=_("b-select"),N=_("b-button"),J=_("b-message"),K=_("b-tag"),Q=_("b-notification"),P=_("b-modal");return w(),V("div",he,[u("div",fe,[u("section",null,[n(b,{label:"数据范围",horizontal:"",class:"datepickerBox",type:r(t)?"is-danger":"",message:r(t)},{default:d(()=>[n(C,{placeholder:"点击选择...",range:"",style:{width:"230px"},size:"is-small","min-date":r(T),"max-date":r(e),onRangeEnd:I,onRangeStart:p},null,8,["min-date","max-date"]),n(z,{style:{margin:"0 10px","line-height":"30px"},label:"日期有效范围为1979-2023,前后范围最短为14天",position:"is-right",type:"is-dark"},{default:d(()=>[n(k,{icon:"circle-exclamation"})]),_:1})]),_:1},8,["type","message"]),n(b,{label:"预测间隔",horizontal:""},{default:d(()=>[n(o,{size:"is-small",type:"is-dark",modelValue:r(s).pred_gap,"onUpdate:modelValue":a[0]||(a[0]=v=>r(s).pred_gap=v),modelModifiers:{number:!0},min:"1",style:{width:"230px",height:"30px"}},null,8,["modelValue"]),a[5]||(a[5]=u("span",{style:{"font-weight":"bold","line-height":"30px"}},"天",-1))]),_:1}),n(b,{label:"分析目标",horizontal:"",class:"gradType"},{default:d(()=>[n(i,{modelValue:r(s).grad_type,"onUpdate:modelValue":a[1]||(a[1]=v=>r(s).grad_type=v),name:"analysisObjective","native-value":"sum",type:"is-black"},{default:d(()=>[...a[6]||(a[6]=[Y(" 均值 ",-1)])]),_:1},8,["modelValue"]),n(i,{modelValue:r(s).grad_type,"onUpdate:modelValue":a[2]||(a[2]=v=>r(s).grad_type=v),name:"analysisObjective","native-value":"l2",type:"is-black"},{default:d(()=>[...a[7]||(a[7]=[Y(" 分布 ",-1)])]),_:1},8,["modelValue"])]),_:1}),n(b,{label:"选定位置",horizontal:""},{default:d(()=>[n(y,{"image-url":Ce,onSelectionString:A})]),_:1}),n(b,{label:"选定变量",horizontal:""},{default:d(()=>[n(x,{placeholder:"选择一个变量",size:"is-small","onUpdate:modelValue":f},{default:d(()=>[(w(),V(F,null,O(h,(v,$)=>u("option",{value:v.value,key:$},E(v.label),9,be)),64))]),_:1})]),_:1}),n(b,{horizontal:""},{default:d(()=>[n(N,{type:"is-dark",size:"is-small",style:{margin:"10px 0"},onClick:R},{default:d(()=>[...a[8]||(a[8]=[Y("提交分析",-1)])]),_:1})]),_:1})])]),u("div",ye,[u("section",null,[n(b,{label:"逐日模型可解释性分析结果热图",horizontal:""},{default:d(()=>[n(z,{label:"缓存最近三条分析记录",position:"is-bottom",type:"is-dark"},{default:d(()=>[n(k,{icon:"circle-exclamation"})]),_:1})]),_:1}),r(m).taskList.length==0?(w(),W(J,{key:0},{default:d(()=>[...a[9]||(a[9]=[Y(" 提交分析之后才会显示结果热图! ",-1)])]),_:1})):Z("",!0)]),u("section",xe,[(w(!0),V(F,null,O(r(m).taskList,(v,$)=>(w(),W(Q,{closable:!1,key:v.task_id},{default:d(()=>[u("div",Me,[u("span",we," 任务id: "+E(v.task_id),1),u("span",ke,[n(K,{type:r(m).resultList[$].status==="完成"?"is-success is-light":"is-warning is-light"},{default:d(()=>[Y(E(r(m).resultList[$].status),1)]),_:2},1032,["type"])])]),u("div",{class:"resultMask",onClick:ee=>H($)},[a[10]||(a[10]=u("img",{src:pe,alt:""},null,-1)),r(m).resultList[$].status==="完成"?(w(),V("span",Se,[n(k,{class:"eyeIcon",icon:"eye"})])):(w(),V("span",Ve,[n(k,{class:"eyeIcon",icon:"eye-slash"})]))],8,Ie),u("div",Le," 提交时间: "+E(v.created_time),1)]),_:2},1024))),128))])]),n(P,{modelValue:r(D),"onUpdate:modelValue":a[3]||(a[3]=v=>j(D)?D.value=v:null)},{default:d(()=>[u("div",Te,[a[11]||(a[11]=u("h3",{class:"title"},"逐日模型可解释性分析结果热图",-1)),u("div",$e,[(w(!0),V(F,null,O(r(m).resultList[r(B)].images,(v,$)=>(w(),V("li",{class:"imgItem",key:$},[u("img",{src:r(L)+v,alt:"Result Image",onClick:ee=>{X.value=v,S.value=!0}},null,8,De)]))),128))])])]),_:1},8,["modelValue"]),n(P,{modelValue:r(S),"onUpdate:modelValue":a[4]||(a[4]=v=>j(S)?S.value=v:null),class:"previewModal"},{default:d(()=>[u("div",null,[u("img",{src:r(L)+r(X),alt:"Preview Image"},null,8,Xe)])]),_:1},8,["modelValue"])])}}},ze=q(Ye,[["__scopeId","data-v-8061a84f"]]);export{ze as default};
