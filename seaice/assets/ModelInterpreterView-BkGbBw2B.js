import{r as y,aV as Z,bm as J,k as X,aU as ee,bn as ae,n as D,w as v,a8 as F,b as r,ac as te,a7 as le,Y,S as se,a5 as q,b0 as j,W as R,V as U,aR as G,Q as oe,bo as ne,_ as K,c as x,d as w,a as k,D as L,aj as re,ak as ue,f as M,am as W,K as ie,aG as E,bi as de,F as P,aC as $,L as ve,bp as ce,bq as me}from"./index-2u-y5e30.js";import{E as fe,a as ge,b as pe,d as be,e as _e}from"./el-radio-BMBHGv4m.js";import{E as ye,c as xe}from"./el-button-Dh5BWkaP.js";import{E as we,I as ke}from"./ImageSelector-CrFXLx4M.js";import{g as T,E as Ce}from"./util-Dq87daa5.js";function $e(t){let e;const a=y(!1),l=Z({...t,originalPosition:"",originalOverflow:"",visible:!1});function i(n){l.text=n}function u(){const n=l.parent,g=p.ns;if(!n.vLoadingAddClassList){let o=n.getAttribute("loading-number");o=Number.parseInt(o)-1,o?n.setAttribute("loading-number",o.toString()):(Y(n,g.bm("parent","relative")),n.removeAttribute("loading-number")),Y(n,g.bm("parent","hidden"))}m(),f.unmount()}function m(){var n,g;(g=(n=p.$el)==null?void 0:n.parentNode)==null||g.removeChild(p.$el)}function c(){var n;t.beforeClose&&!t.beforeClose()||(a.value=!0,clearTimeout(e),e=setTimeout(b,400),l.visible=!1,(n=t.closed)==null||n.call(t))}function b(){if(!a.value)return;const n=l.parent;a.value=!1,n.vLoadingAddClassList=void 0,u()}const d=X({name:"ElLoading",setup(n,{expose:g}){const{ns:o,zIndex:s}=ae("loading");return g({ns:o,zIndex:s}),()=>{const C=l.spinner||l.svg,I=D("svg",{class:"circular",viewBox:l.svgViewBox?l.svgViewBox:"0 0 50 50",...C?{innerHTML:C}:{}},[D("circle",{class:"path",cx:"25",cy:"25",r:"20",fill:"none"})]),A=l.text?D("p",{class:o.b("text")},[l.text]):void 0;return D(le,{name:o.b("fade"),onAfterLeave:b},{default:v(()=>[F(r("div",{style:{backgroundColor:l.background||""},class:[o.b("mask"),l.customClass,l.fullscreen?"is-fullscreen":""]},[D("div",{class:o.b("spinner")},[I,A])]),[[te,l.visible]])])})}}}),f=J(d),p=f.mount(document.createElement("div"));return{...ee(l),setText:i,removeElLoadingChild:m,close:c,handleAfterLeave:b,vm:p,get $el(){return p.$el}}}let h;const Ie=function(t={}){if(!se)return;const e=Ve(t);if(e.fullscreen&&h)return h;const a=$e({...e,closed:()=>{var i;(i=e.closed)==null||i.call(e),e.fullscreen&&(h=void 0)}});Ee(e,e.parent,a),O(e,e.parent,a),e.parent.vLoadingAddClassList=()=>O(e,e.parent,a);let l=e.parent.getAttribute("loading-number");return l?l=`${Number.parseInt(l)+1}`:l="1",e.parent.setAttribute("loading-number",l),e.parent.appendChild(a.$el),q(()=>a.visible.value=e.visible),e.fullscreen&&(h=a),a},Ve=t=>{var e,a,l,i;let u;return j(t.target)?u=(e=document.querySelector(t.target))!=null?e:document.body:u=t.target||document.body,{parent:u===document.body||t.body?document.body:u,background:t.background||"",svg:t.svg||"",svgViewBox:t.svgViewBox||"",spinner:t.spinner||!1,text:t.text||"",fullscreen:u===document.body&&((a=t.fullscreen)!=null?a:!0),lock:(l=t.lock)!=null?l:!1,customClass:t.customClass||"",visible:(i=t.visible)!=null?i:!0,beforeClose:t.beforeClose,closed:t.closed,target:u}},Ee=async(t,e,a)=>{const{nextZIndex:l}=a.vm.zIndex||a.vm._.exposed.zIndex,i={};if(t.fullscreen)a.originalPosition.value=R(document.body,"position"),a.originalOverflow.value=R(document.body,"overflow"),i.zIndex=l();else if(t.parent===document.body){a.originalPosition.value=R(document.body,"position"),await q();for(const u of["top","left"]){const m=u==="top"?"scrollTop":"scrollLeft";i[u]=`${t.target.getBoundingClientRect()[u]+document.body[m]+document.documentElement[m]-Number.parseInt(R(document.body,`margin-${u}`),10)}px`}for(const u of["height","width"])i[u]=`${t.target.getBoundingClientRect()[u]}px`}else a.originalPosition.value=R(e,"position");for(const[u,m]of Object.entries(i))a.$el.style[u]=m},O=(t,e,a)=>{const l=a.vm.ns||a.vm._.exposed.ns;["absolute","fixed","sticky"].includes(a.originalPosition.value)?Y(e,l.bm("parent","relative")):U(e,l.bm("parent","relative")),t.fullscreen&&t.lock?U(e,l.bm("parent","hidden")):Y(e,l.bm("parent","hidden"))},S=Symbol("ElLoading"),z=(t,e)=>{var a,l,i,u;const m=e.instance,c=n=>G(e.value)?e.value[n]:void 0,b=n=>{const g=j(n)&&(m==null?void 0:m[n])||n;return g&&y(g)},d=n=>b(c(n)||t.getAttribute(`element-loading-${ne(n)}`)),f=(a=c("fullscreen"))!=null?a:e.modifiers.fullscreen,p={text:d("text"),svg:d("svg"),svgViewBox:d("svgViewBox"),spinner:d("spinner"),background:d("background"),customClass:d("customClass"),fullscreen:f,target:(l=c("target"))!=null?l:f?void 0:t,body:(i=c("body"))!=null?i:e.modifiers.body,lock:(u=c("lock"))!=null?u:e.modifiers.lock};t[S]={options:p,instance:Ie(p)}},Le=(t,e)=>{for(const a of Object.keys(e))oe(e[a])&&(e[a].value=t[a])},De={mounted(t,e){e.value&&z(t,e)},updated(t,e){const a=t[S];e.oldValue!==e.value&&(e.value&&!e.oldValue?z(t,e):e.value&&e.oldValue?G(e.value)&&Le(e.value,a.options):a==null||a.instance.close())},unmounted(t){var e;(e=t[S])==null||e.instance.close(),t[S]=null}},Re={class:"dynamics-viewer"},Me={class:"viewer-header"},he={key:0,class:"viewer-controls"},Se={key:0,class:"images-grid"},Ye=["src","alt","onClick"],Ae={key:1,class:"empty-state"},Te=["src"],Be={__name:"ModelInterpreterViewer",props:{images:{type:Array,required:!0}},setup(t){const e=t,a=y(null),l=y(1),i=y(!0),u=d=>{d&&(a.value=d,l.value=1)},m=d=>{const f=Math.sign(d.deltaY),p=Math.max(.5,Math.min(5,l.value-f*.2));l.value=p,d.preventDefault()},c=()=>{i.value=!1},b=()=>{i.value=!1,E.error("图片加载失败")};return(d,f)=>{const p=De;return w(),x("div",Re,[k("div",Me,[f[2]||(f[2]=k("h2",{class:"section-title"},"逐日模型可解释性分析结果热图",-1)),e.images&&e.images.length>0?(w(),x("div",he)):L("",!0)]),e.images&&e.images.length>0?(w(),x("div",Se,[(w(!0),x(re,null,ue(e.images,(n,g)=>F((w(),x("div",{key:g,class:"image-container"},[k("img",{src:M(T)(n),alt:`可解释性分析结果 ${g+1}`,class:"analysis-image",style:{transform:"scale(1)"},onClick:o=>u(M(T)(n)),onLoad:c,onError:b},null,40,Ye)])),[[p,i.value]])),128))])):(w(),x("div",Ae,[r(M(Ce),{description:"暂无分析结果"})])),a.value?(w(),x("div",{key:2,class:"modal-overlay",onWheel:m,onClick:f[1]||(f[1]=W(n=>a.value=null,["self"]))},[k("div",{class:"modal-content",style:ie({transform:`scale(${l.value})`})},[k("img",{src:M(T)(a.value),alt:"放大查看",class:"modal-image"},null,8,Te)],4),k("button",{onClick:f[0]||(f[0]=n=>a.value=null),class:"close-button"},f[3]||(f[3]=[k("svg",{class:"close-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[k("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]))],32)):L("",!0)])}}},Ne=K(Be,[["__scopeId","data-v-4af258f5"]]),Ue={class:"container-layout"},Pe={class:"main-content"},Oe={key:0,class:"date-error-tip"},ze={style:{color:"#f56c6c","font-size":"12px"}},Fe={key:0,style:{"margin-top":"8px"}},qe={key:0,class:"loading-container"},je={key:1,class:"result-section"},Ge={__name:"ModelInterpreterView",setup(t){const e=y({dataRange:[],pred_gap:1,grad_type:"sum",position:"",variable:""}),a=y({x:null,y:null}),l=y({x:null,y:null}),i=()=>{a.value.x!==null&&l.value.x!==null?e.value.position=`${a.value.y},${a.value.x};${l.value.y},${a.value.x};${a.value.y},${l.value.x};${l.value.y},${l.value.x}`:e.value.position=""},u=y([]),m=y(!1),c=y(!1),b=y(null),d=y(""),f=o=>{if(!e.value.dataRange[0])return!1;const s=new Date(e.value.dataRange[0].replace(/(\d{4})(\d{2})(\d{2})/,"$1-$2-$3")),C=new Date(s);return C.setDate(s.getDate()+12),o.getTime()<C.getTime()},p=()=>{const{dataRange:o}=e.value;if(d.value="",o[0]&&o[1]){const s=new Date(o[0].replace(/(\d{4})(\d{2})(\d{2})/,"$1-$2-$3")),C=new Date(o[1].replace(/(\d{4})(\d{2})(\d{2})/,"$1-$2-$3"));if(Math.floor((C-s)/(24*60*60*1e3))<13)return d.value="结束日期至少需要比开始日期晚13天",e.value.dataRange[1]="",!1}return!0},n=async()=>{if(b.value)try{const o=await me(b.value);if(o.success&&o.status==="COMPLETED")if(o.data&&o.data.images)u.value=o.data.images,m.value=!0,E.success(o.message||"分析完成"),c.value=!1,b.value=null;else throw new Error("返回数据格式不正确");else if(o.status==="IN_PROGRESS")console.log("任务处理中，继续轮询...");else if(o.status==="FAILED")throw new Error(o.message||"任务处理失败")}catch(o){console.error("轮询分析结果出错:",o),c.value=!1,m.value=!1,E.error(o.message||"获取分析结果失败")}},g=async()=>{if(!e.value.dataRange||!e.value.dataRange[0]||!e.value.dataRange[1]||!e.value.pred_gap||!e.value.grad_type){E.error("请填写必填的分析参数");return}if(!p()){E.error(d.value||"日期范围不符合要求");return}try{c.value=!0,m.value=!1;const o=await ce(e.value.dataRange[0],e.value.dataRange[1],e.value.pred_gap,e.value.grad_type,e.value.position,e.value.variable);if(o.success)b.value=o.data.task_id;else{c.value=!1,E.error(o.message||"提交分析请求失败");return}const s=setInterval(async()=>{await n(),c.value||clearInterval(s)},2e3)}catch(o){m.value=!1,c.value=!1,E.error("提交分析请求失败，请重试"),console.error("Analysis error:",o)}};return de(()=>{b.value&&(b.value=null)}),(o,s)=>{const C=ye,I=pe,A=we,V=_e,B=be,N=xe,H=ge,Q=fe;return w(),x("div",Ue,[k("div",Pe,[r(Q,{class:"box-card"},{default:v(()=>[r(H,{model:e.value,onSubmit:W(g,["prevent"]),class:"analysis-form"},{default:v(()=>[r(I,{label:"数据范围",required:""},{default:v(()=>[r(C,{modelValue:e.value.dataRange[0],"onUpdate:modelValue":s[0]||(s[0]=_=>e.value.dataRange[0]=_),type:"date",placeholder:"选择开始日期",format:"YYYY-MM-DD","value-format":"YYYYMMDD",onChange:p},null,8,["modelValue"]),s[8]||(s[8]=k("span",{style:{margin:"0 8px"}},"至",-1)),r(C,{modelValue:e.value.dataRange[1],"onUpdate:modelValue":s[1]||(s[1]=_=>e.value.dataRange[1]=_),type:"date",placeholder:"选择结束日期",format:"YYYY-MM-DD","value-format":"YYYYMMDD","disabled-date":f,onChange:p},null,8,["modelValue"]),d.value?(w(),x("div",Oe,[k("span",ze,P(d.value),1)])):L("",!0)]),_:1}),r(I,{label:"预测间隔(天)",required:""},{default:v(()=>[r(A,{modelValue:e.value.pred_gap,"onUpdate:modelValue":s[2]||(s[2]=_=>e.value.pred_gap=_),min:1,max:7,placeholder:"预测间隔天数"},null,8,["modelValue"])]),_:1}),r(I,{label:"分析目标",required:""},{default:v(()=>[r(B,{modelValue:e.value.grad_type,"onUpdate:modelValue":s[3]||(s[3]=_=>e.value.grad_type=_)},{default:v(()=>[r(V,{value:"sum"},{default:v(()=>s[9]||(s[9]=[$("均值")])),_:1}),r(V,{value:"l2"},{default:v(()=>s[10]||(s[10]=[$("分布")])),_:1})]),_:1},8,["modelValue"])]),_:1}),r(I,{label:"选定位置"},{default:v(()=>[r(ke,{topLeft:a.value,"onUpdate:topLeft":[s[4]||(s[4]=_=>a.value=_),i],bottomRight:l.value,"onUpdate:bottomRight":[s[5]||(s[5]=_=>l.value=_),i],width:304,height:448},null,8,["topLeft","bottomRight"])]),_:1}),r(I,{label:"选定变量"},{default:v(()=>[r(B,{modelValue:e.value.variable,"onUpdate:modelValue":s[6]||(s[6]=_=>e.value.variable=_)},{default:v(()=>[r(V,{label:"1"},{default:v(()=>s[11]||(s[11]=[$("海冰密集度(SIC)")])),_:1}),r(V,{label:"2"},{default:v(()=>s[12]||(s[12]=[$("海冰U分量(SI_U)")])),_:1}),r(V,{label:"3"},{default:v(()=>s[13]||(s[13]=[$("海冰V分量(SI_V)")])),_:1}),r(V,{label:"4"},{default:v(()=>s[14]||(s[14]=[$("2米温度(T2M)")])),_:1}),r(V,{label:"5"},{default:v(()=>s[15]||(s[15]=[$("10米U风(U10M)")])),_:1}),r(V,{label:"6"},{default:v(()=>s[16]||(s[16]=[$("10米V风(V10M)")])),_:1})]),_:1},8,["modelValue"]),e.value.variable?(w(),x("div",Fe,[r(N,{onClick:s[7]||(s[7]=_=>e.value.variable=""),size:"small"},{default:v(()=>s[17]||(s[17]=[$("取消选择")])),_:1})])):L("",!0)]),_:1}),r(I,null,{default:v(()=>[r(N,{type:"primary",loading:c.value,onClick:g},{default:v(()=>[$(P(c.value?"分析中...":"提交分析"),1)]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"]),c.value?(w(),x("div",qe,[r(ve)])):L("",!0),!c.value&&m.value?(w(),x("div",je,[r(Ne,{images:u.value,class:"full-width"},null,8,["images"])])):L("",!0)]),_:1})])])}}},Je=K(Ge,[["__scopeId","data-v-b92fa11d"]]);export{Je as default};
