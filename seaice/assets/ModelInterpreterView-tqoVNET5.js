import{r as C,aV as H,bm as Q,k as Z,aU as J,bn as X,n as E,w as d,a8 as z,b as u,ac as ee,a7 as ae,Y as S,S as te,a5 as O,b0 as F,W as $,V as B,aR as q,Q as le,bo as se,_ as j,c as p,d as b,a as w,D as I,aj as oe,ak as ne,f as D,am as G,K as re,aG as V,bi as ue,F as N,aC as x,L as ie,bp as de,bq as ce}from"./index-BZYb-IDk.js";import{E as ve,a as me,b as fe,d as ge,e as pe}from"./el-radio-Bwh9qyKW.js";import{E as be,k as _e,c as ye}from"./el-button-3s8mayEW.js";import{E as ke}from"./el-input-number-BLuiG25O.js";import{g as T,E as xe}from"./util-YujQlNxc.js";function we(t){let e;const l=C(!1),s=H({...t,originalPosition:"",originalOverflow:"",visible:!1});function n(a){s.text=a}function r(){const a=s.parent,i=o.ns;if(!a.vLoadingAddClassList){let v=a.getAttribute("loading-number");v=Number.parseInt(v)-1,v?a.setAttribute("loading-number",v.toString()):(S(a,i.bm("parent","relative")),a.removeAttribute("loading-number")),S(a,i.bm("parent","hidden"))}m(),c.unmount()}function m(){var a,i;(i=(a=o.$el)==null?void 0:a.parentNode)==null||i.removeChild(o.$el)}function _(){var a;t.beforeClose&&!t.beforeClose()||(l.value=!0,clearTimeout(e),e=setTimeout(y,400),s.visible=!1,(a=t.closed)==null||a.call(t))}function y(){if(!l.value)return;const a=s.parent;l.value=!1,a.vLoadingAddClassList=void 0,r()}const f=Z({name:"ElLoading",setup(a,{expose:i}){const{ns:v,zIndex:Y}=X("loading");return i({ns:v,zIndex:Y}),()=>{const k=s.spinner||s.svg,L=E("svg",{class:"circular",viewBox:s.svgViewBox?s.svgViewBox:"0 0 50 50",...k?{innerHTML:k}:{}},[E("circle",{class:"path",cx:"25",cy:"25",r:"20",fill:"none"})]),A=s.text?E("p",{class:v.b("text")},[s.text]):void 0;return E(ae,{name:v.b("fade"),onAfterLeave:y},{default:d(()=>[z(u("div",{style:{backgroundColor:s.background||""},class:[v.b("mask"),s.customClass,s.fullscreen?"is-fullscreen":""]},[E("div",{class:v.b("spinner")},[L,A])]),[[ee,s.visible]])])})}}}),c=Q(f),o=c.mount(document.createElement("div"));return{...J(s),setText:n,removeElLoadingChild:m,close:_,handleAfterLeave:y,vm:o,get $el(){return o.$el}}}let M;const Ce=function(t={}){if(!te)return;const e=Ve(t);if(e.fullscreen&&M)return M;const l=we({...e,closed:()=>{var n;(n=e.closed)==null||n.call(e),e.fullscreen&&(M=void 0)}});Ie(e,e.parent,l),U(e,e.parent,l),e.parent.vLoadingAddClassList=()=>U(e,e.parent,l);let s=e.parent.getAttribute("loading-number");return s?s=`${Number.parseInt(s)+1}`:s="1",e.parent.setAttribute("loading-number",s),e.parent.appendChild(l.$el),O(()=>l.visible.value=e.visible),e.fullscreen&&(M=l),l},Ve=t=>{var e,l,s,n;let r;return F(t.target)?r=(e=document.querySelector(t.target))!=null?e:document.body:r=t.target||document.body,{parent:r===document.body||t.body?document.body:r,background:t.background||"",svg:t.svg||"",svgViewBox:t.svgViewBox||"",spinner:t.spinner||!1,text:t.text||"",fullscreen:r===document.body&&((l=t.fullscreen)!=null?l:!0),lock:(s=t.lock)!=null?s:!1,customClass:t.customClass||"",visible:(n=t.visible)!=null?n:!0,beforeClose:t.beforeClose,closed:t.closed,target:r}},Ie=async(t,e,l)=>{const{nextZIndex:s}=l.vm.zIndex||l.vm._.exposed.zIndex,n={};if(t.fullscreen)l.originalPosition.value=$(document.body,"position"),l.originalOverflow.value=$(document.body,"overflow"),n.zIndex=s();else if(t.parent===document.body){l.originalPosition.value=$(document.body,"position"),await O();for(const r of["top","left"]){const m=r==="top"?"scrollTop":"scrollLeft";n[r]=`${t.target.getBoundingClientRect()[r]+document.body[m]+document.documentElement[m]-Number.parseInt($(document.body,`margin-${r}`),10)}px`}for(const r of["height","width"])n[r]=`${t.target.getBoundingClientRect()[r]}px`}else l.originalPosition.value=$(e,"position");for(const[r,m]of Object.entries(n))l.$el.style[r]=m},U=(t,e,l)=>{const s=l.vm.ns||l.vm._.exposed.ns;["absolute","fixed","sticky"].includes(l.originalPosition.value)?S(e,s.bm("parent","relative")):B(e,s.bm("parent","relative")),t.fullscreen&&t.lock?B(e,s.bm("parent","hidden")):S(e,s.bm("parent","hidden"))},R=Symbol("ElLoading"),P=(t,e)=>{var l,s,n,r;const m=e.instance,_=a=>q(e.value)?e.value[a]:void 0,y=a=>{const i=F(a)&&(m==null?void 0:m[a])||a;return i&&C(i)},f=a=>y(_(a)||t.getAttribute(`element-loading-${se(a)}`)),c=(l=_("fullscreen"))!=null?l:e.modifiers.fullscreen,o={text:f("text"),svg:f("svg"),svgViewBox:f("svgViewBox"),spinner:f("spinner"),background:f("background"),customClass:f("customClass"),fullscreen:c,target:(s=_("target"))!=null?s:c?void 0:t,body:(n=_("body"))!=null?n:e.modifiers.body,lock:(r=_("lock"))!=null?r:e.modifiers.lock};t[R]={options:o,instance:Ce(o)}},Ee=(t,e)=>{for(const l of Object.keys(e))le(e[l])&&(e[l].value=t[l])},$e={mounted(t,e){e.value&&P(t,e)},updated(t,e){const l=t[R];e.oldValue!==e.value&&(e.value&&!e.oldValue?P(t,e):e.value&&e.oldValue?q(e.value)&&Ee(e.value,l.options):l==null||l.instance.close())},unmounted(t){var e;(e=t[R])==null||e.instance.close(),t[R]=null}},Le={class:"dynamics-viewer"},De={class:"viewer-header"},Me={key:0,class:"viewer-controls"},Re={key:0,class:"images-grid"},Se=["src","alt","onClick"],Ye={key:1,class:"empty-state"},Ae=["src"],he={__name:"ModelInterpreterViewer",props:{images:{type:Array,required:!0}},setup(t){const e=t,l=C(null),s=C(1),n=C(!0),r=f=>{f&&(l.value=f,s.value=1)},m=f=>{const c=Math.sign(f.deltaY),o=Math.max(.5,Math.min(5,s.value-c*.2));s.value=o,f.preventDefault()},_=()=>{n.value=!1},y=()=>{n.value=!1,V.error("图片加载失败")};return(f,c)=>{const o=$e;return b(),p("div",Le,[w("div",De,[c[2]||(c[2]=w("h2",{class:"section-title"},"逐日模型可解释性分析结果热图",-1)),e.images&&e.images.length>0?(b(),p("div",Me)):I("",!0)]),e.images&&e.images.length>0?(b(),p("div",Re,[(b(!0),p(oe,null,ne(e.images,(a,i)=>z((b(),p("div",{key:i,class:"image-container"},[w("img",{src:D(T)(a),alt:`可解释性分析结果 ${i+1}`,class:"analysis-image",style:{transform:"scale(1)"},onClick:v=>r(D(T)(a)),onLoad:_,onError:y},null,40,Se)])),[[o,n.value]])),128))])):(b(),p("div",Ye,[u(D(xe),{description:"暂无分析结果"})])),l.value?(b(),p("div",{key:2,class:"modal-overlay",onWheel:m,onClick:c[1]||(c[1]=G(a=>l.value=null,["self"]))},[w("div",{class:"modal-content",style:re({transform:`scale(${s.value})`})},[w("img",{src:D(T)(l.value),alt:"放大查看",class:"modal-image"},null,8,Ae)],4),w("button",{onClick:c[0]||(c[0]=a=>l.value=null),class:"close-button"},c[3]||(c[3]=[w("svg",{class:"close-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[w("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]))],32)):I("",!0)])}}},Te=j(he,[["__scopeId","data-v-4af258f5"]]),Be={class:"container-layout"},Ne={class:"main-content"},Ue={key:0,class:"date-error-tip"},Pe={style:{color:"#f56c6c","font-size":"12px"}},ze={key:0,style:{"margin-top":"8px"}},Oe={key:0,style:{"margin-top":"8px"}},Fe={key:0,class:"loading-container"},qe={key:1,class:"result-section"},je={__name:"ModelInterpreterView",setup(t){const e=C({dataRange:[],pred_gap:1,grad_type:"sum",position:"",variable:""}),l=C([]),s=C(!1),n=C(!1),r=C(null),m=C(""),_=o=>{if(!e.value.dataRange[0])return!1;const a=new Date(e.value.dataRange[0].replace(/(\d{4})(\d{2})(\d{2})/,"$1-$2-$3")),i=new Date(a);return i.setDate(a.getDate()+12),o.getTime()<i.getTime()},y=()=>{const{dataRange:o}=e.value;if(m.value="",o[0]&&o[1]){const a=new Date(o[0].replace(/(\d{4})(\d{2})(\d{2})/,"$1-$2-$3")),i=new Date(o[1].replace(/(\d{4})(\d{2})(\d{2})/,"$1-$2-$3"));if(Math.floor((i-a)/(24*60*60*1e3))<13)return m.value="结束日期至少需要比开始日期晚13天",e.value.dataRange[1]="",!1}return!0},f=async()=>{if(r.value)try{const o=await ce(r.value);if(o.success&&o.status==="COMPLETED")if(o.data&&o.data.images)l.value=o.data.images,s.value=!0,V.success(o.message||"分析完成"),n.value=!1,r.value=null;else throw new Error("返回数据格式不正确");else if(o.status==="IN_PROGRESS")console.log("任务处理中，继续轮询...");else if(o.status==="FAILED")throw new Error(o.message||"任务处理失败")}catch(o){console.error("轮询分析结果出错:",o),n.value=!1,s.value=!1,V.error(o.message||"获取分析结果失败")}},c=async()=>{if(!e.value.dataRange||!e.value.dataRange[0]||!e.value.dataRange[1]||!e.value.pred_gap||!e.value.grad_type){V.error("请填写必填的分析参数");return}if(!y()){V.error(m.value||"日期范围不符合要求");return}try{n.value=!0,s.value=!1;const o=await de(e.value.dataRange[0],e.value.dataRange[1],e.value.pred_gap,e.value.grad_type,e.value.position,e.value.variable);if(o.success)r.value=o.data.task_id;else{n.value=!1,V.error(o.message||"提交分析请求失败");return}const a=setInterval(async()=>{await f(),n.value||clearInterval(a)},2e3)}catch(o){s.value=!1,n.value=!1,V.error("提交分析请求失败，请重试"),console.error("Analysis error:",o)}};return ue(()=>{r.value&&(r.value=null)}),(o,a)=>{const i=be,v=fe,Y=ke,k=pe,L=ge,A=_e,h=ye,K=me,W=ve;return b(),p("div",Be,[w("div",Ne,[u(W,{class:"box-card"},{default:d(()=>[u(K,{model:e.value,onSubmit:G(c,["prevent"]),class:"analysis-form"},{default:d(()=>[u(v,{label:"数据范围",required:""},{default:d(()=>[u(i,{modelValue:e.value.dataRange[0],"onUpdate:modelValue":a[0]||(a[0]=g=>e.value.dataRange[0]=g),type:"date",placeholder:"选择开始日期",format:"YYYY-MM-DD","value-format":"YYYYMMDD",onChange:y},null,8,["modelValue"]),a[8]||(a[8]=w("span",{style:{margin:"0 8px"}},"至",-1)),u(i,{modelValue:e.value.dataRange[1],"onUpdate:modelValue":a[1]||(a[1]=g=>e.value.dataRange[1]=g),type:"date",placeholder:"选择结束日期",format:"YYYY-MM-DD","value-format":"YYYYMMDD","disabled-date":_,onChange:y},null,8,["modelValue"]),m.value?(b(),p("div",Ue,[w("span",Pe,N(m.value),1)])):I("",!0)]),_:1}),u(v,{label:"预测间隔(天)",required:""},{default:d(()=>[u(Y,{modelValue:e.value.pred_gap,"onUpdate:modelValue":a[2]||(a[2]=g=>e.value.pred_gap=g),min:1,max:7,placeholder:"预测间隔天数"},null,8,["modelValue"])]),_:1}),u(v,{label:"分析目标",required:""},{default:d(()=>[u(L,{modelValue:e.value.grad_type,"onUpdate:modelValue":a[3]||(a[3]=g=>e.value.grad_type=g)},{default:d(()=>[u(k,{value:"sum"},{default:d(()=>a[9]||(a[9]=[x("海冰面积")])),_:1}),u(k,{value:"l2"},{default:d(()=>a[10]||(a[10]=[x("L2范数")])),_:1})]),_:1},8,["modelValue"])]),_:1}),u(v,{label:"选定位置"},{default:d(()=>[u(A,{modelValue:e.value.position,"onUpdate:modelValue":a[4]||(a[4]=g=>e.value.position=g),placeholder:"输入位置信息，例如100,100;100,200;200,100;200,200"},null,8,["modelValue"]),e.value.position?(b(),p("div",ze,[u(h,{onClick:a[5]||(a[5]=g=>e.value.position=""),size:"small"},{default:d(()=>a[11]||(a[11]=[x("取消选择")])),_:1})])):I("",!0)]),_:1}),u(v,{label:"选定变量"},{default:d(()=>[u(L,{modelValue:e.value.variable,"onUpdate:modelValue":a[6]||(a[6]=g=>e.value.variable=g)},{default:d(()=>[u(k,{label:"1"},{default:d(()=>a[12]||(a[12]=[x("海冰密集度(SIC)")])),_:1}),u(k,{label:"2"},{default:d(()=>a[13]||(a[13]=[x("海冰U分量(SI_U)")])),_:1}),u(k,{label:"3"},{default:d(()=>a[14]||(a[14]=[x("海冰V分量(SI_V)")])),_:1}),u(k,{label:"4"},{default:d(()=>a[15]||(a[15]=[x("2米温度(T2M)")])),_:1}),u(k,{label:"5"},{default:d(()=>a[16]||(a[16]=[x("10米U风(U10M)")])),_:1}),u(k,{label:"6"},{default:d(()=>a[17]||(a[17]=[x("10米V风(V10M)")])),_:1})]),_:1},8,["modelValue"]),e.value.variable?(b(),p("div",Oe,[u(h,{onClick:a[7]||(a[7]=g=>e.value.variable=""),size:"small"},{default:d(()=>a[18]||(a[18]=[x("取消选择")])),_:1})])):I("",!0)]),_:1}),u(v,null,{default:d(()=>[u(h,{type:"primary",loading:n.value,onClick:c},{default:d(()=>[x(N(n.value?"分析中...":"提交分析"),1)]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"]),n.value?(b(),p("div",Fe,[u(ie)])):I("",!0),!n.value&&s.value?(b(),p("div",qe,[u(Te,{images:l.value,class:"full-width"},null,8,["images"])])):I("",!0)]),_:1})])])}}},Ze=j(je,[["__scopeId","data-v-bc605e7a"]]);export{Ze as default};
