import{r as x,aM as Q,aN as Z,k as X,aO as ee,aP as ae,n as D,w as c,a8 as q,a as r,ac as te,a7 as le,Y,j as se,a5 as F,al as j,W as R,V as U,aQ as G,R as oe,aR as ne,_ as W,c as w,b as k,D as $,E as L,ap as re,aq as ue,e as M,as as H,M as ie,aI as E,aJ as de,H as P,aE as C,L as ce,aS as ve,aT as me}from"./index-CPnqO15T.js";import{E as fe,a as ge,b as pe,c as be,d as _e,e as ye,I as xe}from"./ImageSelector-jZ5nrWTB.js";import{g as T,d as we,E as ke,c as Ce}from"./util-CxsDoqGQ.js";function $e(t){let e;const a=x(!1),s=Q({...t,originalPosition:"",originalOverflow:"",visible:!1});function i(n){s.text=n}function u(){const n=s.parent,g=p.ns;if(!n.vLoadingAddClassList){let o=n.getAttribute("loading-number");o=Number.parseInt(o)-1,o?n.setAttribute("loading-number",o.toString()):(Y(n,g.bm("parent","relative")),n.removeAttribute("loading-number")),Y(n,g.bm("parent","hidden"))}m(),f.unmount()}function m(){var n,g;(g=(n=p.$el)==null?void 0:n.parentNode)==null||g.removeChild(p.$el)}function v(){var n;t.beforeClose&&!t.beforeClose()||(a.value=!0,clearTimeout(e),e=setTimeout(b,400),s.visible=!1,(n=t.closed)==null||n.call(t))}function b(){if(!a.value)return;const n=s.parent;a.value=!1,n.vLoadingAddClassList=void 0,u()}const d=X({name:"ElLoading",setup(n,{expose:g}){const{ns:o,zIndex:l}=ae("loading");return g({ns:o,zIndex:l}),()=>{const y=s.spinner||s.svg,I=D("svg",{class:"circular",viewBox:s.svgViewBox?s.svgViewBox:"0 0 50 50",...y?{innerHTML:y}:{}},[D("circle",{class:"path",cx:"25",cy:"25",r:"20",fill:"none"})]),A=s.text?D("p",{class:o.b("text")},[s.text]):void 0;return D(le,{name:o.b("fade"),onAfterLeave:b},{default:c(()=>[q(r("div",{style:{backgroundColor:s.background||""},class:[o.b("mask"),s.customClass,s.fullscreen?"is-fullscreen":""]},[D("div",{class:o.b("spinner")},[I,A])]),[[te,s.visible]])])})}}}),f=Z(d),p=f.mount(document.createElement("div"));return{...ee(s),setText:i,removeElLoadingChild:m,close:v,handleAfterLeave:b,vm:p,get $el(){return p.$el}}}let h;const Ie=function(t={}){if(!se)return;const e=Ve(t);if(e.fullscreen&&h)return h;const a=$e({...e,closed:()=>{var i;(i=e.closed)==null||i.call(e),e.fullscreen&&(h=void 0)}});Ee(e,e.parent,a),O(e,e.parent,a),e.parent.vLoadingAddClassList=()=>O(e,e.parent,a);let s=e.parent.getAttribute("loading-number");return s?s=`${Number.parseInt(s)+1}`:s="1",e.parent.setAttribute("loading-number",s),e.parent.appendChild(a.$el),F(()=>a.visible.value=e.visible),e.fullscreen&&(h=a),a},Ve=t=>{var e,a,s,i;let u;return j(t.target)?u=(e=document.querySelector(t.target))!=null?e:document.body:u=t.target||document.body,{parent:u===document.body||t.body?document.body:u,background:t.background||"",svg:t.svg||"",svgViewBox:t.svgViewBox||"",spinner:t.spinner||!1,text:t.text||"",fullscreen:u===document.body&&((a=t.fullscreen)!=null?a:!0),lock:(s=t.lock)!=null?s:!1,customClass:t.customClass||"",visible:(i=t.visible)!=null?i:!0,beforeClose:t.beforeClose,closed:t.closed,target:u}},Ee=async(t,e,a)=>{const{nextZIndex:s}=a.vm.zIndex||a.vm._.exposed.zIndex,i={};if(t.fullscreen)a.originalPosition.value=R(document.body,"position"),a.originalOverflow.value=R(document.body,"overflow"),i.zIndex=s();else if(t.parent===document.body){a.originalPosition.value=R(document.body,"position"),await F();for(const u of["top","left"]){const m=u==="top"?"scrollTop":"scrollLeft";i[u]=`${t.target.getBoundingClientRect()[u]+document.body[m]+document.documentElement[m]-Number.parseInt(R(document.body,`margin-${u}`),10)}px`}for(const u of["height","width"])i[u]=`${t.target.getBoundingClientRect()[u]}px`}else a.originalPosition.value=R(e,"position");for(const[u,m]of Object.entries(i))a.$el.style[u]=m},O=(t,e,a)=>{const s=a.vm.ns||a.vm._.exposed.ns;["absolute","fixed","sticky"].includes(a.originalPosition.value)?Y(e,s.bm("parent","relative")):U(e,s.bm("parent","relative")),t.fullscreen&&t.lock?U(e,s.bm("parent","hidden")):Y(e,s.bm("parent","hidden"))},S=Symbol("ElLoading"),z=(t,e)=>{var a,s,i,u;const m=e.instance,v=n=>G(e.value)?e.value[n]:void 0,b=n=>{const g=j(n)&&(m==null?void 0:m[n])||n;return g&&x(g)},d=n=>b(v(n)||t.getAttribute(`element-loading-${ne(n)}`)),f=(a=v("fullscreen"))!=null?a:e.modifiers.fullscreen,p={text:d("text"),svg:d("svg"),svgViewBox:d("svgViewBox"),spinner:d("spinner"),background:d("background"),customClass:d("customClass"),fullscreen:f,target:(s=v("target"))!=null?s:f?void 0:t,body:(i=v("body"))!=null?i:e.modifiers.body,lock:(u=v("lock"))!=null?u:e.modifiers.lock};t[S]={options:p,instance:Ie(p)}},Le=(t,e)=>{for(const a of Object.keys(e))oe(e[a])&&(e[a].value=t[a])},De={mounted(t,e){e.value&&z(t,e)},updated(t,e){const a=t[S];e.oldValue!==e.value&&(e.value&&!e.oldValue?z(t,e):e.value&&e.oldValue?G(e.value)&&Le(e.value,a.options):a==null||a.instance.close())},unmounted(t){var e;(e=t[S])==null||e.instance.close(),t[S]=null}},Re={class:"dynamics-viewer"},Me={class:"viewer-header"},he={key:0,class:"viewer-controls"},Se={key:0,class:"images-grid"},Ye=["src","alt","onClick"],Ae={key:1,class:"empty-state"},Te=["src"],Be={__name:"ModelInterpreterViewer",props:{images:{type:Array,required:!0}},setup(t){const e=t,a=x(null),s=x(1),i=x(!0),u=d=>{d&&(a.value=d,s.value=1)},m=d=>{const f=Math.sign(d.deltaY),p=Math.max(.5,Math.min(5,s.value-f*.2));s.value=p,d.preventDefault()},v=()=>{i.value=!1},b=()=>{i.value=!1,E.error("图片加载失败")};return(d,f)=>{const p=De;return k(),w("div",Re,[$("div",Me,[f[2]||(f[2]=$("h2",{class:"section-title"},"逐日模型可解释性分析结果热图",-1)),e.images&&e.images.length>0?(k(),w("div",he)):L("",!0)]),e.images&&e.images.length>0?(k(),w("div",Se,[(k(!0),w(re,null,ue(e.images,(n,g)=>q((k(),w("div",{key:g,class:"image-container"},[$("img",{src:M(T)(n),alt:`可解释性分析结果 ${g+1}`,class:"analysis-image",style:{transform:"scale(1)"},onClick:o=>u(M(T)(n)),onLoad:v,onError:b},null,40,Ye)])),[[p,i.value]])),128))])):(k(),w("div",Ae,[r(M(we),{description:"暂无分析结果"})])),a.value?(k(),w("div",{key:2,class:"modal-overlay",onWheel:m,onClick:f[1]||(f[1]=H(n=>a.value=null,["self"]))},[$("div",{class:"modal-content",style:ie({transform:`scale(${s.value})`})},[$("img",{src:M(T)(a.value),alt:"放大查看",class:"modal-image"},null,8,Te)],4),$("button",{onClick:f[0]||(f[0]=n=>a.value=null),class:"close-button"},f[3]||(f[3]=[$("svg",{class:"close-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[$("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]))],32)):L("",!0)])}}},Ne=W(Be,[["__scopeId","data-v-4af258f5"]]),Ue={class:"container-layout"},Pe={key:0,class:"date-error-tip"},Oe={style:{color:"#f56c6c","font-size":"12px"}},ze={key:0,style:{"margin-top":"8px"}},qe={key:0,class:"loading-container"},Fe={key:1,class:"result-section"},je={__name:"ModelInterpreterView",setup(t){const e=x({dataRange:[],pred_gap:1,grad_type:"sum",position:"",variable:""}),a=x({x:null,y:null}),s=x({x:null,y:null}),i=()=>{if(a.value.x!==null&&s.value.x!==null){const l=448-a.value.y,y=448-s.value.y;e.value.position=`${l},${a.value.x};${y},${a.value.x};${l},${s.value.x};${y},${s.value.x}`}else e.value.position=""},u=x([]),m=x(!1),v=x(!1),b=x(null),d=x(""),f=o=>{if(!e.value.dataRange[0])return!1;const l=new Date(e.value.dataRange[0].replace(/(\d{4})(\d{2})(\d{2})/,"$1-$2-$3")),y=new Date(l);return y.setDate(l.getDate()+12),o.getTime()<y.getTime()},p=()=>{const{dataRange:o}=e.value;if(d.value="",o[0]&&o[1]){const l=new Date(o[0].replace(/(\d{4})(\d{2})(\d{2})/,"$1-$2-$3")),y=new Date(o[1].replace(/(\d{4})(\d{2})(\d{2})/,"$1-$2-$3"));if(Math.floor((y-l)/(24*60*60*1e3))<13)return d.value="结束日期至少需要比开始日期晚13天",e.value.dataRange[1]="",!1}return!0},n=async()=>{if(b.value)try{const o=await me(b.value);if(o.success&&o.status==="COMPLETED")if(o.data&&o.data.images)u.value=o.data.images,m.value=!0,E.success(o.message||"分析完成"),v.value=!1,b.value=null;else throw new Error("返回数据格式不正确");else if(o.status==="IN_PROGRESS")console.log("任务处理中，继续轮询...");else if(o.status==="FAILED")throw new Error(o.message||"任务处理失败")}catch(o){console.error("轮询分析结果出错:",o),v.value=!1,m.value=!1,E.error(o.message||"获取分析结果失败")}},g=async()=>{if(!e.value.dataRange||!e.value.dataRange[0]||!e.value.dataRange[1]||!e.value.pred_gap||!e.value.grad_type){E.error("请填写必填的分析参数");return}if(!p()){E.error(d.value||"日期范围不符合要求");return}try{v.value=!0,m.value=!1;const o=await ve(e.value.dataRange[0],e.value.dataRange[1],e.value.pred_gap,e.value.grad_type,e.value.position,e.value.variable);if(o.success)b.value=o.data.task_id;else{v.value=!1,E.error(o.message||"提交分析请求失败");return}const l=setInterval(async()=>{await n(),v.value||clearInterval(l)},2e3)}catch(o){m.value=!1,v.value=!1,E.error("提交分析请求失败，请重试"),console.error("Analysis error:",o)}};return de(()=>{b.value&&(b.value=null)}),(o,l)=>{const y=ke,I=pe,A=be,V=ye,B=_e,N=Ce,K=ge,J=fe;return k(),w("div",Ue,[r(J,{class:"box-card"},{default:c(()=>[r(K,{model:e.value,onSubmit:H(g,["prevent"]),class:"analysis-form"},{default:c(()=>[r(I,{label:"数据范围",required:""},{default:c(()=>[r(y,{modelValue:e.value.dataRange[0],"onUpdate:modelValue":l[0]||(l[0]=_=>e.value.dataRange[0]=_),type:"date",placeholder:"选择开始日期",format:"YYYY-MM-DD","value-format":"YYYYMMDD",onChange:p},null,8,["modelValue"]),l[8]||(l[8]=$("span",{style:{margin:"0 8px"}},"至",-1)),r(y,{modelValue:e.value.dataRange[1],"onUpdate:modelValue":l[1]||(l[1]=_=>e.value.dataRange[1]=_),type:"date",placeholder:"选择结束日期",format:"YYYY-MM-DD","value-format":"YYYYMMDD","disabled-date":f,onChange:p},null,8,["modelValue"]),d.value?(k(),w("div",Pe,[$("span",Oe,P(d.value),1)])):L("",!0)]),_:1}),r(I,{label:"预测间隔(天)",required:""},{default:c(()=>[r(A,{modelValue:e.value.pred_gap,"onUpdate:modelValue":l[2]||(l[2]=_=>e.value.pred_gap=_),min:1,max:7,placeholder:"预测间隔天数"},null,8,["modelValue"])]),_:1}),r(I,{label:"分析目标",required:""},{default:c(()=>[r(B,{modelValue:e.value.grad_type,"onUpdate:modelValue":l[3]||(l[3]=_=>e.value.grad_type=_)},{default:c(()=>[r(V,{value:"sum"},{default:c(()=>l[9]||(l[9]=[C("均值")])),_:1}),r(V,{value:"l2"},{default:c(()=>l[10]||(l[10]=[C("分布")])),_:1})]),_:1},8,["modelValue"])]),_:1}),r(I,{label:"选定位置"},{default:c(()=>[r(xe,{topLeft:a.value,"onUpdate:topLeft":[l[4]||(l[4]=_=>a.value=_),i],bottomRight:s.value,"onUpdate:bottomRight":[l[5]||(l[5]=_=>s.value=_),i],width:304,height:448},null,8,["topLeft","bottomRight"])]),_:1}),r(I,{label:"选定变量"},{default:c(()=>[r(B,{modelValue:e.value.variable,"onUpdate:modelValue":l[6]||(l[6]=_=>e.value.variable=_)},{default:c(()=>[r(V,{label:"1"},{default:c(()=>l[11]||(l[11]=[C("海冰密集度(SIC)")])),_:1}),r(V,{label:"2"},{default:c(()=>l[12]||(l[12]=[C("海冰U分量(SI_U)")])),_:1}),r(V,{label:"3"},{default:c(()=>l[13]||(l[13]=[C("海冰V分量(SI_V)")])),_:1}),r(V,{label:"4"},{default:c(()=>l[14]||(l[14]=[C("2米温度(T2M)")])),_:1}),r(V,{label:"5"},{default:c(()=>l[15]||(l[15]=[C("10米U风(U10M)")])),_:1}),r(V,{label:"6"},{default:c(()=>l[16]||(l[16]=[C("10米V风(V10M)")])),_:1})]),_:1},8,["modelValue"]),e.value.variable?(k(),w("div",ze,[r(N,{onClick:l[7]||(l[7]=_=>e.value.variable=""),size:"small"},{default:c(()=>l[17]||(l[17]=[C("取消选择")])),_:1})])):L("",!0)]),_:1}),r(I,null,{default:c(()=>[r(N,{type:"primary",loading:v.value,onClick:g},{default:c(()=>[C(P(v.value?"分析中...":"提交分析"),1)]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"]),v.value?(k(),w("div",qe,[r(ce)])):L("",!0),!v.value&&m.value?(k(),w("div",Fe,[r(Ne,{images:u.value,class:"full-width"},null,8,["images"])])):L("",!0)]),_:1})])}}},Ke=W(je,[["__scopeId","data-v-9e8260f8"]]);export{Ke as default};
