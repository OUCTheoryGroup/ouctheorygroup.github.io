import{p as W,f as X,q as Z,r as ee,u as te,v as ae,w as se,x as le,y as oe,A as ie,B as ne,C as re,D as m}from"./element-plus-vendor-BSOUQG5-.js";import{r as u,x as E,m as p,J as N,G as y,M as o,K as r,a6 as ue,u as g,s as a,I as de,P as k,n as ce,O as S,o as d}from"./vue-vendor-DB0sj3qF.js";import{_ as me,L as pe,a as ve}from"./index-CpiUH-Zi.js";const ge={class:"upload-container"},_e={key:1,class:"form-content"},fe={class:"upload-header"},he={class:"upload-progress"},ye={class:"progress-text"},ke={class:"hint-text"},we={class:"date-picker-section"},De={class:"upload-area"},Le={key:0,class:"upload-trigger"},Pe={key:1,class:"upload-complete"},be={class:"custom-upload-item"},Ie=["src"],xe={class:"upload-item-overlay"},Ee={class:"upload-item-actions"},Ue={class:"image-date-label"},$e={class:"submit-section"},Me={key:2,class:"loading-container"},Ce={key:3,class:"results-container"},Ne={key:0},Se={key:1,class:"empty-results"},Be={class:"preview-container"},Re=["src"],qe={__name:"ImageUploadPredictor",props:{timeMode:{type:String,required:!0},imageLimit:{type:Number,required:!0},selectedDate:{type:[Date,String],required:!0},getPredictionResult:{type:Function,required:!0},submitPredictionRequest:{type:Function,required:!0}},emits:["update:selectedDate"],setup(P,{emit:B}){const l=P,R=B,w=u([]),_=u(!1),n=u([]),U=u(""),b=u(!1),f=u([]),c=u(!1),D=u(null),h=u(null),I=u(null),L=u([]);E(()=>l.selectedDate,e=>{I.value=e,$()}),E(n,()=>{$()});const $=()=>{if(!I.value)return;const e=[],t=new Date(I.value);for(let s=0;s<l.imageLimit;s++){const i=new Date(t);l.timeMode==="daily"?i.setDate(i.getDate()+s):l.timeMode==="monthly"?i.setMonth(i.getMonth()+s):console.log("Unhandled timeMode:",l.timeMode),e.push(q(i))}L.value=e},q=e=>{const t=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0");return`${t}-${s}-${i}`},V=e=>!L.value.length||e>=L.value.length?"未设置日期":L.value[e];E(n,e=>{e.length===l.imageLimit&&m.success(`已成功选择${l.imageLimit}张图片`)});const G=e=>new Promise((t,s)=>{const i=new FileReader;i.readAsDataURL(e),i.onload=()=>t(i.result),i.onerror=x=>s(x)}),z=e=>e.type==="image/png"?n.value.length>=l.imageLimit?(m.error(`已达到${l.imageLimit}张图片上限`),!1):!0:(m.error("仅支持PNG文件"),!1),A=(e,t)=>{const s=e.image_url;s&&f.value.push(s),m.success(`${t.name} 上传成功`)},F=(e,t)=>{m.error(`${t.name} 上传失败`),console.error("Upload error:",e)},M=async e=>{!e.url&&!e.preview&&(e.preview=await G(e.raw)),U.value=e.url||e.preview,b.value=!0},C=e=>{n.value=n.value.filter(s=>s.uid!==e.uid);const t=n.value.findIndex(s=>s.uid===e.uid);t!==-1&&f.value.splice(t,1),m.warning(`还需上传${l.imageLimit-n.value.length}张图片`)},T=async()=>{if(D.value)try{const e=await l.getPredictionResult(D.value);e.length!=0&&(w.value=e,_.value=!0,clearInterval(h.value),c.value=!1)}catch(e){if(e.response&&e.response.status===400){console.log("Task not completed yet, continuing polling...");return}clearInterval(h.value),c.value=!1,m.error("获取预测结果失败"),console.error("Error:",e)}},J=async()=>{try{c.value=!0;const e=await l.submitPredictionRequest(l.selectedDate,f.value);D.value=e.task_id,h.value=setInterval(T,2e3)}catch(e){c.value=!1,m.error("提交预测请求失败"),console.error("Error:",e)}},K=()=>{_.value=!1,w.value=[],n.value=[],f.value=[],D.value=null,h.value&&clearInterval(h.value),R("update:selectedDate",null)};return(e,t)=>{const s=X,i=Z,x=ee,O=oe,Y=ne,j=re;return d(),p("div",ge,[_.value?(d(),N(i,{key:0,class:"back-button",onClick:K},{default:r(()=>[o(s,null,{default:r(()=>[o(g(W))]),_:1}),t[2]||(t[2]=ue(" 返回 "))]),_:1})):y("",!0),_.value?y("",!0):(d(),p("div",_e,[a("div",fe,[t[4]||(t[4]=a("h3",null,"图片上传",-1)),a("div",he,[a("div",ye,[t[3]||(t[3]=a("span",null,"已上传: ",-1)),a("span",{class:de({complete:n.value.length===l.imageLimit})},k(n.value.length)+"/"+k(l.imageLimit),3)]),o(x,{percentage:n.value.length/l.imageLimit*100,"stroke-width":8,"show-text":!1,status:n.value.length===l.imageLimit?"success":""},null,8,["percentage","status"])]),a("p",ke,"请上传"+k(l.imageLimit)+"张PNG格式图片",1)]),a("div",we,[ce(e.$slots,"date-picker",{},void 0,!0),t[5]||(t[5]=a("p",{class:"date-hint"},"选择的日期将作为第一张图片的日期",-1))]),a("div",De,[o(O,{"file-list":n.value,"onUpdate:fileList":t[0]||(t[0]=v=>n.value=v),class:"image-uploader",action:"https://seaice.52lxy.one:20443/seaice/png-upload",accept:".png","list-type":"picture-card",multiple:!0,limit:P.imageLimit,"before-upload":z,"on-preview":M,"on-success":A,"on-error":F,"on-remove":C,"auto-upload":!0},{default:r(()=>[n.value.length<l.imageLimit?(d(),p("div",Le,[o(s,{class:"upload-icon"},{default:r(()=>[o(g(se))]),_:1}),t[6]||(t[6]=a("div",{class:"upload-text"},"点击上传",-1)),t[7]||(t[7]=a("div",{class:"upload-hint"},"仅支持PNG格式",-1))])):(d(),p("div",Pe,[o(s,{class:"complete-icon"},{default:r(()=>[o(g(le))]),_:1}),t[8]||(t[8]=a("div",{class:"complete-text"},"上传完成",-1))]))]),file:r(({file:v,index:H})=>[a("div",be,[a("img",{class:"upload-thumbnail",src:v.url,alt:""},null,8,Ie),a("div",xe,[a("div",Ee,[o(i,{circle:"",type:"primary",onClick:S(Q=>M(v),["stop"])},{default:r(()=>[o(s,null,{default:r(()=>[o(g(te))]),_:1})]),_:2},1032,["onClick"]),o(i,{circle:"",type:"danger",onClick:S(Q=>C(v),["stop"])},{default:r(()=>[o(s,null,{default:r(()=>[o(g(ae))]),_:1})]),_:2},1032,["onClick"])])]),a("div",Ue,[a("span",null,k(V(H)),1)])])]),_:1},8,["file-list","limit"])]),a("div",$e,[o(i,{type:"primary",size:"large",onClick:J,loading:c.value,disabled:n.value.length!==l.imageLimit||!P.selectedDate||f.value.length!==l.imageLimit,class:"submit-button"},{default:r(()=>[c.value?y("",!0):(d(),N(s,{key:0},{default:r(()=>[o(g(ie))]),_:1})),a("span",null,k(c.value?"分析中...":"提交分析"),1)]),_:1},8,["loading","disabled"])])])),c.value?(d(),p("div",Me,[o(pe),t[9]||(t[9]=a("p",{class:"loading-text"},"正在分析您的图片，请稍候...",-1))])):y("",!0),!c.value&&_.value?(d(),p("div",Ce,[w.value.length?(d(),p("div",Ne,[o(ve,{images:w.value},null,8,["images"])])):(d(),p("div",Se,[o(Y,{description:"暂无预测结果"}),t[10]||(t[10]=a("p",null,"请上传图片并选择日期以查看预测结果",-1))]))])):y("",!0),o(j,{modelValue:b.value,"onUpdate:modelValue":t[1]||(t[1]=v=>b.value=v),title:"图片预览",width:"50%",center:"","destroy-on-close":""},{default:r(()=>[a("div",Be,[a("img",{class:"preview-image",src:U.value,alt:"Preview Image"},null,8,Re)])]),_:1},8,["modelValue"])])}}},Ae=me(qe,[["__scopeId","data-v-fd1b4db4"]]);export{Ae as I};
