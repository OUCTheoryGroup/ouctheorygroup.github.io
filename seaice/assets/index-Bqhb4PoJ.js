import{_ as R}from"./result_mask-DVoKs7o9.js";import{b as tt,p as et,u as st}from"./index-CU0F9wed.js";import{d as ot,r as f,_ as lt,w as at,e as U,q as nt,s as it,g as u,c as h,o as p,a as s,i as a,j as d,k as B,u as l,t as k,F as N,l as A,n as L,m as F,x as ct,y as E,z as ut}from"./index-BtW-4A07.js";const rt=ot("predictionTest",()=>{const r=f([]),o=f([]);function v(e){for(;e.value.length>3;)C(e.value[2].timerId),e.value.splice(3)}function c(e,T){r.value.unshift({task_id:e,type:T,created_time:new Date().toLocaleString()}),I({status:"处理中",task_id:e,timeId:null,type:T}),g(o.value[0]),v(r)}function I(e){o.value.unshift(e),v(o)}function g(e,T=2e3){C(e.timerId),e.timerId=setInterval(async()=>{try{const b=await tt(e.task_id,e.type);(b.status==="COMPLETED"||b.status==="FAILED")&&(e.status=b.status==="COMPLETED"?"完成":"失败",e.images=b.data.images,clearInterval(e.timerId),e.timerId=null)}catch{}},T)}function y(){for(const e of o.value)e.status!="完成"&&e.status!="失败"&&g(e)}function $(){for(const e of o.value)e.timerId&&(clearInterval(e.timerId),e.timerId=null)}function C(e){e&&(clearInterval(e),e=null)}return{taskList:r,addTask:c,resultList:o,addResult:I,pollTaskStatus:g,clearAllTimers:$,pollAllTaskStatus:y}},{persist:{enabled:!0,strategies:[{key:"predictionTest",storage:localStorage,paths:["taskList","resultList"]}]}}),dt={class:"forecastTestContainer"},pt={class:"formContainer"},_t={style:{margin:"10px 0"}},mt={class:"upload-dropzone"},vt={class:"uploadIconBox"},ft={class:"uploadHint"},gt={class:"tags"},yt=["onClick"],bt={class:"resultContainer"},ht={class:"title"},kt={class:"resultList"},Tt={class:"taskId"},Lt={class:"idBox"},xt={class:"tag"},wt=["onClick"],It={key:0,class:"iconBox"},Ct={key:1,class:"iconBox"},Vt={class:"createdTime"},Dt={class:"modalBox"},Mt={class:"content"},Et={class:"carouselBox",style:{display:"flex","justify-content":"center","flex-direction":"column","align-items":"center"}},$t=["src"],Bt={__name:"index",setup(z){const r=rt(),o=f([]),v=f(null),c=f("daily"),I=n=>{const t=new Date(n).getFullYear(),_=new Date(n).getMonth()+1,x=new Date(n).getDate(),D=_<10?"0"+_:_,w=x<10?"0"+x:x;v.value=c.value==="monthly"?`${t}/${D}`:`${t}/${D}/${w}`};at(c,n=>{o.value=[],v.value=null});const g=f([]),y=U(()=>c.value==="daily"?14:12),$=n=>{o.value.splice(n,1)},C=n=>{const t=n.filter(_=>_.type==="image/png"||/\.png$/i.test(_.name));o.value=t.slice(0,y.value)},e=U(()=>`已上传文件数: ${o.value.length} / ${y.value}`),T=async()=>{if(o.value.length===0){E("请先上传图片后再提交分析！");return}if(!v.value){E("请选择一个日期作为第一张图片的日期！");return}try{await b(o.value);const n=await et(c.value,v.value,g.value);if(n.success){ut("提交分析成功！请前往任务列表查看结果。");const t=n.data;r.addTask(t.task_id,c.value)}}catch{E("提交分析失败, 请重试！")}finally{G()}},b=async n=>{await st(n).then(t=>{g.value=t}).catch(t=>{E("图片上传失败, 请重试！")})},G=()=>{o.value=[],v.value=null,g.value=[]},V=f(!1),S=f(null),H=n=>{r.resultList[n].status==="完成"&&(V.value=!0,S.value=n)};return nt(()=>{r.pollAllTaskStatus()}),it(()=>{r.clearAllTimers()}),(n,t)=>{const _=u("b-tab-item"),x=u("b-tabs"),D=u("b-progress"),w=u("b-field"),X=u("b-datepicker"),M=u("vue-fontawesome"),O=u("b-upload"),j=u("b-button"),q=u("b-tooltip"),Y=u("b-message"),P=u("b-tag"),J=u("b-notification"),K=u("b-carousel-item"),Q=u("b-carousel"),W=u("b-modal");return p(),h("div",dt,[s("div",pt,[t[6]||(t[6]=s("h3",{class:"title"},"上传图片进行预测",-1)),a(x,{type:"is-toggle",size:"is-small",class:"typeTabs",modelValue:l(c),"onUpdate:modelValue":t[2]||(t[2]=i=>B(c)?c.value=i:null)},{default:d(()=>[a(_,{label:"逐日",value:"daily",onClick:t[0]||(t[0]=i=>c.value="daily")}),a(_,{label:"逐月",value:"monthly",onClick:t[1]||(t[1]=i=>c.value="monthly")})]),_:1},8,["modelValue"]),s("section",null,[a(w,{label:l(e),require:""},{default:d(()=>[a(D,{style:{margin:"10px auto"},value:l(o).length,max:l(y)},null,8,["value","max"])]),_:1},8,["label"])]),s("section",_t,[a(w,{label:l(c)==="monthly"?"选择一个月份作为第一张图片的起始月份":"选择一个日期作为第一张图片的日期"},{default:d(()=>[a(X,{type:l(c)==="monthly"?"month":void 0,"onUpdate:modelValue":I,size:"is-small",style:{width:"330px"},placeholder:l(c)==="monthly"?"点击选择月份":"点击选择日期","trap-focus":""},null,8,["type","placeholder"])]),_:1},8,["label"])]),s("section",null,[a(w,null,{default:d(()=>[a(O,{modelValue:l(o),"onUpdate:modelValue":[t[3]||(t[3]=i=>B(o)?o.value=i:null),C],multiple:"","drag-drop":"",accept:"image/png",disabled:l(o).length>=l(y)},{default:d(()=>[s("section",mt,[s("p",vt,[a(M,{icon:"upload"})]),s("p",ft,"仅支持PNG：拖拽文件到此处或点击上传（请上传 "+k(l(y))+" 张）",1)])]),_:1},8,["modelValue","disabled"])]),_:1}),s("div",gt,[(p(!0),h(N,null,A(l(o),(i,m)=>(p(),h("span",{key:m,class:"tag is-light is-dark"},[L(k(i.name)+" ",1),s("button",{class:"delete is-small",type:"button",onClick:Z=>$(m)},null,8,yt)]))),128))])]),a(j,{class:"submitBtn",type:"is-dark",size:"is-small",onClick:T},{default:d(()=>[...t[5]||(t[5]=[L("提交分析",-1)])]),_:1})]),s("div",bt,[s("h3",ht,[t[7]||(t[7]=L("预测结果 ",-1)),a(q,{label:"缓存3个预测结果",position:"is-right",type:"is-dark"},{default:d(()=>[a(M,{icon:"circle-exclamation"})]),_:1})]),s("section",null,[l(r).taskList.length==0?(p(),F(Y,{key:0},{default:d(()=>[...t[8]||(t[8]=[L(" 提交分析之后才会显示预测结果! ",-1)])]),_:1})):ct("",!0)]),s("section",kt,[(p(!0),h(N,null,A(l(r).taskList,(i,m)=>(p(),F(J,{closable:!1,key:i.task_id},{default:d(()=>[s("div",Tt,[s("span",Lt," 任务id: "+k(i.task_id),1),s("span",xt,[a(P,{type:"is-info is-light"},{default:d(()=>[L(k(i.type==="daily"?"逐日预测":"逐月预测"),1)]),_:2},1024),a(P,{type:l(r).resultList[m].status==="完成"?"is-success is-light":"is-warning is-light"},{default:d(()=>[L(k(l(r).resultList[m].status),1)]),_:2},1032,["type"])])]),s("div",{class:"resultMask",onClick:Z=>H(m)},[t[9]||(t[9]=s("img",{src:R,alt:""},null,-1)),l(r).resultList[m].status==="完成"?(p(),h("span",It,[a(M,{class:"eyeIcon",icon:"eye"})])):(p(),h("span",Ct,[a(M,{class:"eyeIcon",icon:"eye-slash"})]))],8,wt),s("div",Vt," 提交时间: "+k(i.created_time),1)]),_:2},1024))),128))])]),a(W,{modelValue:l(V),"onUpdate:modelValue":t[4]||(t[4]=i=>B(V)?V.value=i:null)},{default:d(()=>[s("div",Dt,[t[10]||(t[10]=s("h3",{class:"title"},"模型预报测试结果",-1)),s("div",Mt,[a(Q,{"progress-type":"is-dark","pause-text":""},{default:d(()=>[(p(!0),h(N,null,A(l(r).resultList[l(S)].images,(i,m)=>(p(),F(K,{key:m},{default:d(()=>[s("section",null,[s("div",Et,[s("img",{src:i.path,alt:""},null,8,$t),s("p",null,k(i.date),1)])])]),_:2},1024))),128))]),_:1})])])]),_:1},8,["modelValue"])])}}},St=lt(Bt,[["__scopeId","data-v-fe2b8a8c"]]);export{St as default};
