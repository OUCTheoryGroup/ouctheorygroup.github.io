import{_ as q,b as z,r as I,w as O,e as J,f as Q,g as L,c as V,o as N,a as H,h as R,v as $,i as C,j as D,k as W,u as U,F as Y,l as G,m as K,n as X,t as ee,p as te,q as ae,s as ne}from"./index-UoqNg9qr.js";import{g as le,a as re}from"./index-C3aR6gbg.js";const oe="/seaice/assets/basemap_8k-DIYoJH_7.webp",se={class:"cesiumComponentContainer"},ie={class:"controllerContainer"},ce={class:"playAndPause"},ue={style:{flex:"1",margin:"0 10px"}},de={__name:"index",props:{initialCoords:{type:Array,default:()=>[-180,-90,180,90]},autoStart:{type:Boolean,default:!0},isPlaying:{type:Boolean,default:!0},switchInterval:{type:Number,default:1500},fetchedUrls:{type:Array,default:()=>[]},dateType:{type:String,default:"daily"}},emits:["handlePlay","handlePause"],setup(b,{expose:v}){let l=window.Cesium;const T=z(),o=b,i=I(null),t={id:null};let s=null;const u=I(0),_=I(null),w=I(null),c=I(null),y=()=>{t.id||(t.id=setInterval(e,o.switchInterval))},d=()=>{t.id&&(clearInterval(t.id),t.id=null)},F=()=>{d(),u.value=0,e(0),y()},e=a=>{let n;a!==void 0?n=a:n=(u.value+1)%o.fetchedUrls.length;const r=S(n%o.fetchedUrls.length),p=r&&r.imageryProvider;try{r.alpha=0,r.show=!1}catch{}g(p,5e3).then(async m=>{try{u.value=n,r.show=!0,c.value.raiseToTop(r),await f(r,0,1,600);try{c.value.remove(w.value,!0)}catch{}w.value=r}catch{try{c.value.remove(w.value,!0)}catch{}w.value=r,u.value=n}}).catch(m=>{setTimeout(()=>{try{c.value.remove(w.value,!0)}catch{}w.value=r,u.value=n},100)})},h=()=>{u.value=0,w.value=S(u.value)},f=(a,n,r,p=600)=>new Promise(m=>{const k=performance.now(),P=B=>{const E=Math.min(1,(B-k)/p),Z=n+(r-n)*E;try{a.alpha=Z}catch{}E<1?requestAnimationFrame(P):m()};requestAnimationFrame(P)}),g=(a,n=5e3)=>{if(!a||!a.readyPromise)return Promise.resolve();let r=null;return Promise.race([a.readyPromise,new Promise((p,m)=>{r=setTimeout(()=>m(new Error("provider ready timeout")),n)})]).finally(()=>{r&&clearTimeout(r)})},A=async()=>{l.Ion.defaultAccessToken=void 0;const a=new l.SingleTileImageryProvider({url:oe,rectangle:l.Rectangle.fromDegrees(...o.initialCoords)});s||(s=document.createElement("div"),s.style.position="absolute",s.style.width="0px",s.style.height="0px",s.style.overflow="hidden",s.style.left="-9999px",s.style.top="-9999px",document.body.appendChild(s)),i.value=new l.Viewer("cesiumContainer",{timeline:!1,animation:!1,geocoder:!1,homeButton:!1,sceneModePicker:!1,baseLayerPicker:!1,navigationHelpButton:!1,fullscreenButton:!1,baseLayer:new l.ImageryLayer(a),creditContainer:s}),c.value=i.value.imageryLayers;const n=i.value.scene.globe.tileLoadProgressEvent.addEventListener(function(m){m===0&&(requestAnimationFrame(function(){T.isLoading=!1,y()}),n())}),r=i.value.entities.add({position:l.Cartesian3.fromDegrees(0,90,0),description:"North Pole Anchor"});i.value.trackedEntity=r;const p=i.value.scene.screenSpaceCameraController;p.enableTilt=!0,p.enableZoom=!0,p.enableRotate=!0,p.constrainedAxis=l.Cartesian3.UNIT_Z;try{_.value=i.value.imageryLayers.get(0)}catch{_.value=null}try{const P=l.Cartesian3.fromDegrees(0,89.5,3e7),B=l.Cartesian3.fromDegrees(0,90,15e6);i.value.camera.setView({destination:P}),await i.value.camera.flyTo({destination:B,orientation:{heading:0,pitch:-Math.PI/2,roll:0},duration:2,easingFunction:l.EasingFunction.QUADRATIC_IN_OUT})}catch{}try{const m=_.value&&_.value.imageryProvider;g(m,5e3).then(()=>{h()})}catch{h()}},S=a=>{if(a<0||a>=o.fetchedUrls.length)return;const n=o.fetchedUrls[a],r=n.path||n.url||n;let p;try{p=c.value.addImageryProvider(new l.SingleTileImageryProvider({url:r,rectangle:l.Rectangle.fromDegrees(-180,-90,180,90)}))}catch{}return p},x=a=>{if(!(typeof a!="number"||a<0||a>o.fetchedUrls.length)){if(!o.isPlaying){e(a);return}d(),e(a),y()}};O(()=>o.isPlaying,a=>{a?y():d()});const j=J(()=>{if(o.fetchedUrls&&o.fetchedUrls.length>0){const a=o.fetchedUrls[0];if(a&&typeof a=="object"&&a.date)return o.fetchedUrls.map(n=>n.date)}});return Q(()=>{if(i.value&&!i.value.isDestroyed())try{i.value.destroy()}catch{}t.id&&(clearInterval(t.id),t.id=null);try{s&&s.parentNode&&s.parentNode.removeChild(s)}catch{}s=null}),v({initCesium:A,restart:F}),(a,n)=>{const r=L("vue-fontawesome"),p=L("b-slider-tick"),m=L("b-slider"),k=L("b-field");return N(),V("div",se,[n[3]||(n[3]=H("div",{id:"cesiumContainer"},null,-1)),H("div",ie,[H("div",ce,[R(C(r,{onClick:n[0]||(n[0]=P=>a.$emit("handlePlay")),icon:"circle-play",class:"has-text-white",size:"lg"},null,512),[[$,!b.isPlaying]]),R(C(r,{onClick:n[1]||(n[1]=P=>a.$emit("handlePause")),icon:"circle-pause",class:"has-text-white",size:"lg"},null,512),[[$,b.isPlaying]])]),H("section",ue,[C(k,null,{default:D(()=>[C(m,{onChange:x,modelValue:U(u),"onUpdate:modelValue":n[2]||(n[2]=P=>W(u)?u.value=P:null),min:0,max:o.fetchedUrls.length||14,ticks:""},{default:D(()=>[(N(!0),V(Y,null,G(o.fetchedUrls.length,(P,B)=>(N(),K(p,{key:P,value:P},{default:D(()=>[X(ee(U(j)[B]),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue","max"])]),_:1})])])])}}},me=q(de,[["__scopeId","data-v-a3933454"]]);function M(b=[],v={}){const{concurrency:l=2,initialBatch:T=3,onProgress:o=null,name:i=""}=v,t=new Array(b.length).fill("pending");let s=!1;const u=(...e)=>{if(typeof o=="function")try{o(...e)}catch{}},_=new Set;function w(e,{timeoutMs:h=15e3}={}){return e<0||e>=b.length||t[e]==="loaded"||t[e]==="loading"?Promise.resolve():(t[e]="loading",u(e,t[e],i),new Promise(f=>{const g=new Image;_.add(g);let A=null;const S=x=>{A&&(clearTimeout(A),A=null),g.onload=null,g.onerror=null,_.delete(g),f(x)};g.onload=()=>{t[e]="loaded",u(e,t[e],i),S({index:e,status:"loaded"})},g.onerror=()=>{t[e]="error",u(e,t[e],i),S({index:e,status:"error"})},h>0&&(A=setTimeout(()=>{t[e]="error",u(e,t[e],i),g.onload=null,g.onerror=null;try{g.src=""}catch{}_.delete(g),f({index:e,status:"error",reason:"timeout"})},h)),g.src=b[e]}))}async function c(){if(s)return;const e=Math.min(T,b.length),h=[];for(let f=0;f<e;f++)h.push(w(f));await Promise.all(h),s=!0}async function y(){let e=0;const h=new Array(Math.max(1,l)).fill(0).map(async()=>{for(;;){const f=e++;if(f>=b.length)return;t[f]==="loaded"||t[f]==="error"||await w(f)}});await Promise.all(h)}function d(){for(const e of _)try{e.onload=null,e.onerror=null,e.src=""}catch{}_.clear();for(let e=0;e<t.length;e++)(t[e]==="loading"||t[e]==="pending")&&(t[e]="error",u(e,t[e],i))}function F(){d()}return{urls:b,status:t,get initialLoaded(){return s},loadInitial:c,loadAll:y,cancelAll:d,dispose:F}}const fe={class:"realTimeForecastContainer"},ye={__name:"index",setup(b){const v=z(),l=I(null),T=I([]),o=I([]),i=I([]);let t=null,s=null;function u(c,y,d){}const _=async()=>{try{const c=await le();o.value=c||[];const y=(c||[]).map(d=>d.path||d.url||d);t=M(y,{concurrency:3,initialBatch:3,onProgress:u,name:"daily"}),await t.loadInitial(),v.dateType==="daily"&&(T.value=o.value)}catch{}},w=async()=>{try{const c=await re();i.value=c||[];const y=(c||[]).map(d=>d.path||d.url||d);s=M(y,{concurrency:2,initialBatch:0,onProgress:u,name:"monthly"}),s.loadAll().then(()=>{})}catch{}};return O(()=>v.dateType,async c=>{c==="daily"?T.value=o.value:T.value=i.value,te().then(()=>{l.value&&l.value.restart()})}),ae(async()=>{if(v.isLoading=!0,await Promise.allSettled([_(),w()]),t&&t.loadAll().then(()=>{}),l.value&&typeof l.value.initCesium=="function")try{l.value.initCesium()}catch{}}),ne(()=>{l.value&&(l.value=null),t&&(t.cancelAll(),t=null)}),(c,y)=>{const d=L("b-tab-item"),F=L("b-tabs"),e=L("b-section"),h=me;return N(),V("div",fe,[C(e,{class:"switcherSection"},{default:D(()=>[C(F,{type:"is-toggle",size:"is-small",modelValue:U(v).dateType,"onUpdate:modelValue":y[0]||(y[0]=f=>U(v).dateType=f)},{default:D(()=>[C(d,{label:"未来14日",value:"daily"}),C(d,{label:"未来12月",value:"monthly"})]),_:1},8,["modelValue"])]),_:1}),C(h,{"date-type":U(v).dateType,"fetched-urls":T.value,onHandlePlay:U(v).play,onHandlePause:U(v).pause,"is-playing":U(v).isPlaying,ref_key:"sphereRef",ref:l},null,8,["date-type","fetched-urls","onHandlePlay","onHandlePause","is-playing"])])}}},ve=q(ye,[["__scopeId","data-v-ef0d28da"]]);export{ve as default};
