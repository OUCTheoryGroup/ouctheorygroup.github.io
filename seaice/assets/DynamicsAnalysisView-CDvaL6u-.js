import{aI as A,an as B,n as ye,aJ as he,aK as Ve,B as Ne,m as oe,C as Ie,p as we,r as $,aL as Ee,E as D,aM as z,U as ee,o as ue,aN as ke,c as E,e as V,a8 as te,F,b as m,g as s,ar as O,G as Q,s as G,w as h,f as W,aO as Se,aP as Me,K as le,aQ as Ae,aF as $e,ab as Ce,as as L,aB as ne,S as Fe,al as De,af as Pe,_ as ie,a as w,ap as xe,aq as Be,H as Z,M as se,aH as Le,aD as X,L as Re,aR as Te,aS as Ue}from"./index-BqVaevRk.js";import{E as Ye,a as Ke,b as ze,c as Oe,d as Ge}from"./el-form-item-CYCQ1je-.js";import{U as P,I as j,C as de,f as We,g as He,a as je,v as re,h as ce,j as qe,d as Je,E as Qe,c as Xe,e as H}from"./el-button-BP5sAS0I.js";import"./file_commonjsHelpers-Bmp0PTBq.js";const Ze=ye({id:{type:String,default:void 0},step:{type:Number,default:1},stepStrictly:Boolean,max:{type:Number,default:Number.POSITIVE_INFINITY},min:{type:Number,default:Number.NEGATIVE_INFINITY},modelValue:Number,readonly:Boolean,disabled:Boolean,size:Ve,controls:{type:Boolean,default:!0},controlsPosition:{type:String,default:"",values:["","right"]},valueOnClear:{type:[String,Number,null],validator:r=>r===null||A(r)||["min","max"].includes(r),default:null},name:String,placeholder:String,precision:{type:Number,validator:r=>r>=0&&r===Number.parseInt(`${r}`,10)},validateEvent:{type:Boolean,default:!0},...he(["ariaLabel"])}),ea={[de]:(r,l)=>l!==r,blur:r=>r instanceof FocusEvent,focus:r=>r instanceof FocusEvent,[j]:r=>A(r)||B(r),[P]:r=>A(r)||B(r)},aa=oe({name:"ElInputNumber"}),ta=oe({...aa,props:Ze,emits:ea,setup(r,{expose:l,emit:p}){const t=r,{t:g}=Ie(),_=we("input-number"),k=$(),o=Ee({currentValue:t.modelValue,userInput:null}),{formItem:i}=We(),d=D(()=>A(t.modelValue)&&t.modelValue<=t.min),S=D(()=>A(t.modelValue)&&t.modelValue>=t.max),u=D(()=>{const e=R(t.step);return z(t.precision)?Math.max(R(t.modelValue),e):(e>t.precision,t.precision)}),c=D(()=>t.controls&&t.controlsPosition==="right"),b=He(),y=je(),C=D(()=>{if(o.userInput!==null)return o.userInput;let e=o.currentValue;if(B(e))return"";if(A(e)){if(Number.isNaN(e))return"";z(t.precision)||(e=e.toFixed(t.precision))}return e}),x=(e,a)=>{if(z(a)&&(a=u.value),a===0)return Math.round(e);let n=String(e);const v=n.indexOf(".");if(v===-1||!n.replace(".","").split("")[v+a])return e;const Y=n.length;return n.charAt(Y-1)==="5"&&(n=`${n.slice(0,Math.max(0,Y-1))}6`),Number.parseFloat(Number(n).toFixed(a))},R=e=>{if(B(e))return 0;const a=e.toString(),n=a.indexOf(".");let v=0;return n!==-1&&(v=a.length-n-1),v},T=(e,a=1)=>A(e)?x(e+t.step*a):o.currentValue,I=()=>{if(t.readonly||y.value||S.value)return;const e=Number(C.value)||0,a=T(e);U(a),p(j,o.currentValue),J()},q=()=>{if(t.readonly||y.value||d.value)return;const e=Number(C.value)||0,a=T(e,-1);U(a),p(j,o.currentValue),J()},ae=(e,a)=>{const{max:n,min:v,step:f,precision:M,stepStrictly:Y,valueOnClear:K}=t;n<v&&Fe("InputNumber","min should not be greater than max.");let N=Number(e);if(B(e)||Number.isNaN(N))return null;if(e===""){if(K===null)return null;N=De(K)?{min:v,max:n}[K]:K}return Y&&(N=x(Math.round(N/f)*f,M),N!==e&&a&&p(P,N)),z(M)||(N=x(N,M)),(N>n||N<v)&&(N=N>n?n:v,a&&p(P,N)),N},U=(e,a=!0)=>{var n;const v=o.currentValue,f=ae(e);if(!a){p(P,f);return}v===f&&e||(o.userInput=null,p(P,f),v!==f&&p(de,f,v),t.validateEvent&&((n=i==null?void 0:i.validate)==null||n.call(i,"change").catch(M=>ne())),o.currentValue=f)},me=e=>{o.userInput=e;const a=e===""?null:Number(e);p(j,a),U(a,!1)},pe=e=>{const a=e!==""?Number(e):"";(A(a)&&!Number.isNaN(a)||e==="")&&U(a),J(),o.userInput=null},ve=()=>{var e,a;(a=(e=k.value)==null?void 0:e.focus)==null||a.call(e)},fe=()=>{var e,a;(a=(e=k.value)==null?void 0:e.blur)==null||a.call(e)},ge=e=>{p("focus",e)},_e=e=>{var a,n;o.userInput=null,qe()&&o.currentValue===null&&((a=k.value)!=null&&a.input)&&(k.value.input.value=""),p("blur",e),t.validateEvent&&((n=i==null?void 0:i.validate)==null||n.call(i,"blur").catch(v=>ne()))},J=()=>{o.currentValue!==t.modelValue&&(o.currentValue=t.modelValue)},be=e=>{document.activeElement===e.target&&e.preventDefault()};return ee(()=>t.modelValue,(e,a)=>{const n=ae(e,!0);o.userInput===null&&n!==a&&(o.currentValue=n)},{immediate:!0}),ue(()=>{var e;const{min:a,max:n,modelValue:v}=t,f=(e=k.value)==null?void 0:e.input;if(f.setAttribute("role","spinbutton"),Number.isFinite(n)?f.setAttribute("aria-valuemax",String(n)):f.removeAttribute("aria-valuemax"),Number.isFinite(a)?f.setAttribute("aria-valuemin",String(a)):f.removeAttribute("aria-valuemin"),f.setAttribute("aria-valuenow",o.currentValue||o.currentValue===0?String(o.currentValue):""),f.setAttribute("aria-disabled",String(y.value)),!A(v)&&v!=null){let M=Number(v);Number.isNaN(M)&&(M=null),p(P,M)}f.addEventListener("wheel",be,{passive:!1})}),ke(()=>{var e,a;const n=(e=k.value)==null?void 0:e.input;n==null||n.setAttribute("aria-valuenow",`${(a=o.currentValue)!=null?a:""}`)}),l({focus:ve,blur:fe}),(e,a)=>(V(),E("div",{class:Q([s(_).b(),s(_).m(s(b)),s(_).is("disabled",s(y)),s(_).is("without-controls",!e.controls),s(_).is("controls-right",s(c))]),onDragstart:L(()=>{},["prevent"])},[e.controls?te((V(),E("span",{key:0,role:"button","aria-label":s(g)("el.inputNumber.decrease"),class:Q([s(_).e("decrease"),s(_).is("disabled",s(d))]),onKeydown:O(q,["enter"])},[G(e.$slots,"decrease-icon",{},()=>[m(s(le),null,{default:h(()=>[s(c)?(V(),W(s(Se),{key:0})):(V(),W(s(Me),{key:1}))]),_:1})])],42,["aria-label","onKeydown"])),[[s(re),q]]):F("v-if",!0),e.controls?te((V(),E("span",{key:1,role:"button","aria-label":s(g)("el.inputNumber.increase"),class:Q([s(_).e("increase"),s(_).is("disabled",s(S))]),onKeydown:O(I,["enter"])},[G(e.$slots,"increase-icon",{},()=>[m(s(le),null,{default:h(()=>[s(c)?(V(),W(s(Ae),{key:0})):(V(),W(s($e),{key:1}))]),_:1})])],42,["aria-label","onKeydown"])),[[s(re),I]]):F("v-if",!0),m(s(ce),{id:e.id,ref_key:"input",ref:k,type:"number",step:e.step,"model-value":s(C),placeholder:e.placeholder,readonly:e.readonly,disabled:s(y),size:s(b),max:e.max,min:e.min,name:e.name,"aria-label":e.ariaLabel,"validate-event":!1,onKeydown:[O(L(I,["prevent"]),["up"]),O(L(q,["prevent"]),["down"])],onBlur:_e,onFocus:ge,onInput:me,onChange:pe},Ce({_:2},[e.$slots.prefix?{name:"prefix",fn:h(()=>[G(e.$slots,"prefix")])}:void 0,e.$slots.suffix?{name:"suffix",fn:h(()=>[G(e.$slots,"suffix")])}:void 0]),1032,["id","step","model-value","placeholder","readonly","disabled","size","max","min","name","aria-label","onKeydown"])],42,["onDragstart"]))}});var la=Ne(ta,[["__file","input-number.vue"]]);const na=Pe(la),sa={class:"dynamics-viewer"},ra={class:"image-container"},oa={key:0,class:"loading-overlay"},ua=["src","alt","onClick","onLoad"],ia={class:"image-date-label"},da={key:0,class:"empty-state"},ca=["src"],ma={class:"image-date"},pa={__name:"DynamicsAnalysisViewer",props:{images:{type:Array,required:!0}},setup(r){const l=r,p=$(null),t=$(1),g=$([]),_=D(()=>!l.images||l.images.length===0?1:Math.ceil(l.images.length/2)),k=u=>new Promise((c,b)=>{const y=new Image;y.onload=()=>c(),y.onerror=b,y.src=u}),o=()=>{!l.images||l.images.length===0||l.images.forEach((u,c)=>{k(u.path).then(()=>{g.value[c]=!1}).catch(b=>{console.error(`Failed to load image: ${u.path}`,b),g.value[c]=!1})})};ee(()=>l.images,u=>{u&&u.length>0&&(g.value=new Array(u.length).fill(!0),o())},{immediate:!0});const i=u=>{g.value[u]=!1},d=u=>{u&&(p.value=u,t.value=1)},S=u=>{const c=Math.sign(u.deltaY),b=Math.max(1,Math.min(3,t.value-c*.2));t.value=b,u.preventDefault()};return ue(()=>{o()}),(u,c)=>(V(),E("div",sa,[c[4]||(c[4]=w("h2",{class:"section-title"},"动力学分析结果热图",-1)),w("div",{class:"image-grid",style:se({"--images-per-row":_.value})},[(V(!0),E(xe,null,Be(r.images,(b,y)=>(V(),E("div",{key:y,class:"image-card"},[w("div",ra,[g.value[y]?(V(),E("div",oa,c[2]||(c[2]=[w("div",{class:"loading-spinner"},null,-1)]))):F("",!0),w("img",{src:b.path,alt:`${b.date} - 动力学分析结果`,class:"analysis-image",onClick:C=>d(b),onLoad:C=>i(y)},null,40,ua)]),w("div",ia,Z(b.date),1)]))),128))],4),!r.images||r.images.length===0?(V(),E("div",da,[m(s(Je),{description:"暂无分析结果"})])):F("",!0),p.value?(V(),E("div",{key:1,class:"modal-overlay",onWheel:S,onClick:c[1]||(c[1]=L(b=>p.value=null,["self"]))},[w("div",{class:"modal-content",style:se({transform:`scale(${t.value})`})},[w("img",{src:p.value.path,alt:"放大查看",class:"modal-image"},null,8,ca),w("p",ma,Z(p.value.date),1)],4),w("button",{onClick:c[0]||(c[0]=b=>p.value=null),class:"close-button"},c[3]||(c[3]=[w("svg",{class:"close-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[w("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]))],32)):F("",!0)]))}},va=ie(pa,[["__scopeId","data-v-25b0c470"]]),fa={class:"container-layout"},ga={class:"main-content"},_a={key:0,class:"loading-container"},ba={key:1,class:"result-section"},ya={__name:"DynamicsAnalysisView",setup(r){const l=$({dataRange:[],grad_forecast_month:1,grad_month:"",grad_lat_lon:"",grad_type:"sum"}),p=$([]),t=$(!1),g=$(!1),_=$(null);ee([()=>l.value.dataRange,()=>l.value.grad_forecast_month],([i,d])=>{if(i&&i[1]&&d){const S=new Date(i[1].substring(0,4),parseInt(i[1].substring(4))-1);S.setMonth(S.getMonth()+d),l.value.grad_month=String(S.getMonth()+1).padStart(2,"0")}else l.value.grad_month=""});const k=async()=>{if(_.value)try{const i=await Ue(_.value);i.length!==0&&(p.value=i,t.value=!0,H.success("分析完成"),g.value=!1,_.value=null)}catch(i){if(i.response&&i.response.status===400){console.log("Task not completed yet, continuing polling...");return}console.error("轮询分析结果出错:",i),g.value=!1,t.value=!1,H.error("获取分析结果失败")}},o=async()=>{if(!l.value.dataRange||!l.value.dataRange[0]||!l.value.dataRange[1]||!l.value.grad_month||!l.value.grad_forecast_month){H.error("请填写完整的分析参数");return}try{g.value=!0,t.value=!1;const i=await Te(l.value.dataRange[0],l.value.dataRange[1],l.value.grad_type,l.value.grad_month);_.value=i.task_id;const d=setInterval(async()=>{await k(),g.value||clearInterval(d)},2e3)}catch(i){t.value=!1,g.value=!1,H.error("提交分析请求失败，请重试"),console.error("Analysis error:",i)}};return Le(()=>{_.value&&(_.value=null)}),(i,d)=>{const S=Qe,u=ze,c=na,b=ce,y=Ge,C=Oe,x=Xe,R=Ke,T=Ye;return V(),E("div",fa,[w("div",ga,[m(T,{class:"box-card"},{default:h(()=>[m(R,{model:l.value,onSubmit:L(o,["prevent"]),class:"analysis-form"},{default:h(()=>[m(u,{label:"数据范围"},{default:h(()=>[m(S,{modelValue:l.value.dataRange,"onUpdate:modelValue":d[0]||(d[0]=I=>l.value.dataRange=I),type:"monthrange","range-separator":"至","start-placeholder":"开始月份","end-placeholder":"结束月份",format:"YYYY-MM","value-format":"YYYYMM"},null,8,["modelValue"])]),_:1}),m(u,{label:"预报提前期"},{default:h(()=>[m(c,{modelValue:l.value.grad_forecast_month,"onUpdate:modelValue":d[1]||(d[1]=I=>l.value.grad_forecast_month=I),min:1,placeholder:"请输入提前期（月）"},null,8,["modelValue"])]),_:1}),m(u,{label:"目标月份"},{default:h(()=>[m(S,{modelValue:l.value.grad_month,"onUpdate:modelValue":d[2]||(d[2]=I=>l.value.grad_month=I),type:"month",placeholder:"目标月份由数据范围和预报提前期决定",format:"MM","value-format":"MM",disabled:""},null,8,["modelValue"])]),_:1}),m(u,{label:"分析范围"},{default:h(()=>[m(b,{modelValue:l.value.grad_lat_lon,"onUpdate:modelValue":d[3]||(d[3]=I=>l.value.grad_lat_lon=I),disabled:"",placeholder:"请输入经纬度范围（目前只支持全范围）"},null,8,["modelValue"])]),_:1}),m(u,{label:"分析目标"},{default:h(()=>[m(C,{modelValue:l.value.grad_type,"onUpdate:modelValue":d[4]||(d[4]=I=>l.value.grad_type=I)},{default:h(()=>[m(y,{value:"sum"},{default:h(()=>d[5]||(d[5]=[X("海冰面积")])),_:1}),m(y,{value:"variation"},{default:h(()=>d[6]||(d[6]=[X("海冰变化")])),_:1})]),_:1},8,["modelValue"])]),_:1}),m(u,null,{default:h(()=>[m(x,{type:"primary",loading:g.value,onClick:o},{default:h(()=>[X(Z(g.value?"分析中...":"提交分析"),1)]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"]),g.value?(V(),E("div",_a,[m(Re)])):F("",!0),!g.value&&t.value?(V(),E("div",ba,[m(va,{images:p.value,class:"full-width"},null,8,["images"])])):F("",!0)]),_:1})])])}}},wa=ie(ya,[["__scopeId","data-v-312fdcea"]]);export{wa as default};
