import{_ as tt}from"./result_mask-DVoKs7o9.js";import{b as et,p as st,u as ot}from"./index-BbFGagmH.js";import{d as lt,r as v,_ as at,w as nt,e as U,q as it,s as ct,g as u,c as b,o as p,a as s,i as a,j as d,k as B,u as o,t as h,F as N,l as A,n as T,m as F,x as rt,y as $,z as ut}from"./index-CwjyL_I4.js";const dt=lt("predictionTest",()=>{const L=v([]),i=v([]);function c(e){for(;e.value.length>3;)V(e.value[2].timerId),e.value.splice(3)}function f(e,k){L.value.unshift({task_id:e,type:k,created_time:new Date().toLocaleString()}),r({status:"处理中",task_id:e,timeId:null,type:k}),x(i.value[0]),c(L)}function r(e){i.value.unshift(e),c(i)}function x(e,k=2e3){V(e.timerId),e.timerId=setInterval(async()=>{try{const y=await et(e.task_id,e.type);(y.status==="COMPLETED"||y.status==="FAILED")&&(e.status=y.status==="COMPLETED"?"完成":"失败",e.images=y.data.images,clearInterval(e.timerId),e.timerId=null)}catch{}},k)}function w(){for(const e of i.value)e.status!="完成"&&e.status!="失败"&&x(e)}function g(){for(const e of i.value)e.timerId&&(clearInterval(e.timerId),e.timerId=null)}function V(e){e&&(clearInterval(e),e=null)}return{taskList:L,addTask:f,resultList:i,addResult:r,pollTaskStatus:x,clearAllTimers:g,pollAllTaskStatus:w}},{persist:{enabled:!0,strategies:[{key:"predictionTest",storage:localStorage,paths:["taskList","resultList"]}]}}),pt={class:"forecastTestContainer"},_t={class:"formContainer"},mt={style:{margin:"10px 0"}},vt={class:"upload-dropzone"},ft={class:"uploadIconBox"},gt={class:"uploadHint"},yt={class:"tags"},bt=["onClick"],ht={class:"resultContainer"},kt={class:"title"},Tt={class:"resultList"},Lt={class:"taskId"},xt={class:"idBox"},wt={class:"tag"},It=["onClick"],Ct={key:0,class:"iconBox"},Vt={key:1,class:"iconBox"},Dt={class:"createdTime"},Mt={class:"modalBox"},Et={class:"content"},$t={class:"carouselBox",style:{display:"flex","justify-content":"center","flex-direction":"column","align-items":"center"}},Bt=["src"],Nt={__name:"index",setup(z){const L="https://assets-seaice-eo.52lxy.top",i=dt(),c=v([]),f=v(null),r=v("daily"),x=n=>{const t=new Date(n).getFullYear(),_=new Date(n).getMonth()+1,I=new Date(n).getDate(),M=_<10?"0"+_:_,C=I<10?"0"+I:I;f.value=r.value==="monthly"?`${t}/${M}`:`${t}/${M}/${C}`};nt(r,n=>{c.value=[],f.value=null});const w=v([]),g=U(()=>r.value==="daily"?14:12),V=n=>{c.value.splice(n,1)},e=n=>{const t=n.filter(_=>_.type==="image/png"||/\.png$/i.test(_.name));c.value=t.slice(0,g.value)},k=U(()=>`已上传文件数: ${c.value.length} / ${g.value}`),y=async()=>{if(c.value.length===0){$("请先上传图片后再提交分析！");return}if(!f.value){$("请选择一个日期作为第一张图片的日期！");return}try{await G(c.value);const n=await st(r.value,f.value,w.value);if(n.success){ut("提交分析成功！请前往任务列表查看结果。");const t=n.data;i.addTask(t.task_id,r.value)}}catch{$("提交分析失败, 请重试！")}finally{H()}},G=async n=>{await ot(n).then(t=>{w.value=t}).catch(t=>{$("图片上传失败, 请重试！")})},H=()=>{c.value=[],f.value=null,w.value=[]},D=v(!1),S=v(null),X=n=>{i.resultList[n].status==="完成"&&(D.value=!0,S.value=n)};return it(()=>{i.pollAllTaskStatus()}),ct(()=>{i.clearAllTimers()}),(n,t)=>{const _=u("b-tab-item"),I=u("b-tabs"),M=u("b-progress"),C=u("b-field"),O=u("b-datepicker"),E=u("vue-fontawesome"),j=u("b-upload"),q=u("b-button"),W=u("b-tooltip"),Y=u("b-message"),P=u("b-tag"),J=u("b-notification"),K=u("b-carousel-item"),Q=u("b-carousel"),Z=u("b-modal");return p(),b("div",pt,[s("div",_t,[t[6]||(t[6]=s("h3",{class:"title"},"上传图片进行预测",-1)),a(I,{type:"is-toggle",size:"is-small",class:"typeTabs",modelValue:o(r),"onUpdate:modelValue":t[2]||(t[2]=l=>B(r)?r.value=l:null)},{default:d(()=>[a(_,{label:"逐日",value:"daily",onClick:t[0]||(t[0]=l=>r.value="daily")}),a(_,{label:"逐月",value:"monthly",onClick:t[1]||(t[1]=l=>r.value="monthly")})]),_:1},8,["modelValue"]),s("section",null,[a(C,{label:o(k),require:""},{default:d(()=>[a(M,{style:{margin:"10px auto"},value:o(c).length,max:o(g)},null,8,["value","max"])]),_:1},8,["label"])]),s("section",mt,[a(C,{label:o(r)==="monthly"?"选择一个月份作为第一张图片的起始月份":"选择一个日期作为第一张图片的日期"},{default:d(()=>[a(O,{type:o(r)==="monthly"?"month":void 0,"onUpdate:modelValue":x,size:"is-small",style:{width:"330px"},placeholder:o(r)==="monthly"?"点击选择月份":"点击选择日期","trap-focus":""},null,8,["type","placeholder"])]),_:1},8,["label"])]),s("section",null,[a(C,null,{default:d(()=>[a(j,{modelValue:o(c),"onUpdate:modelValue":[t[3]||(t[3]=l=>B(c)?c.value=l:null),e],multiple:"","drag-drop":"",accept:"image/png",disabled:o(c).length>=o(g)},{default:d(()=>[s("section",vt,[s("p",ft,[a(E,{icon:"upload"})]),s("p",gt,"仅支持PNG：拖拽文件到此处或点击上传（请上传 "+h(o(g))+" 张）",1)])]),_:1},8,["modelValue","disabled"])]),_:1}),s("div",yt,[(p(!0),b(N,null,A(o(c),(l,m)=>(p(),b("span",{key:m,class:"tag is-light is-dark"},[T(h(l.name)+" ",1),s("button",{class:"delete is-small",type:"button",onClick:R=>V(m)},null,8,bt)]))),128))])]),a(q,{class:"submitBtn",type:"is-dark",size:"is-small",onClick:y},{default:d(()=>[...t[5]||(t[5]=[T("提交分析",-1)])]),_:1})]),s("div",ht,[s("h3",kt,[t[7]||(t[7]=T("预测结果 ",-1)),a(W,{label:"缓存3个预测结果",position:"is-right",type:"is-dark"},{default:d(()=>[a(E,{icon:"circle-exclamation"})]),_:1})]),s("section",null,[o(i).taskList.length==0?(p(),F(Y,{key:0},{default:d(()=>[...t[8]||(t[8]=[T(" 提交分析之后才会显示预测结果! ",-1)])]),_:1})):rt("",!0)]),s("section",Tt,[(p(!0),b(N,null,A(o(i).taskList,(l,m)=>(p(),F(J,{closable:!1,key:l.task_id},{default:d(()=>[s("div",Lt,[s("span",xt," 任务id: "+h(l.task_id),1),s("span",wt,[a(P,{type:"is-info is-light"},{default:d(()=>[T(h(l.type==="daily"?"逐日预测":"逐月预测"),1)]),_:2},1024),a(P,{type:o(i).resultList[m].status==="完成"?"is-success is-light":"is-warning is-light"},{default:d(()=>[T(h(o(i).resultList[m].status),1)]),_:2},1032,["type"])])]),s("div",{class:"resultMask",onClick:R=>X(m)},[t[9]||(t[9]=s("img",{src:tt,alt:""},null,-1)),o(i).resultList[m].status==="完成"?(p(),b("span",Ct,[a(E,{class:"eyeIcon",icon:"eye"})])):(p(),b("span",Vt,[a(E,{class:"eyeIcon",icon:"eye-slash"})]))],8,It),s("div",Dt," 提交时间: "+h(l.created_time),1)]),_:2},1024))),128))])]),a(Z,{modelValue:o(D),"onUpdate:modelValue":t[4]||(t[4]=l=>B(D)?D.value=l:null)},{default:d(()=>[s("div",Mt,[t[10]||(t[10]=s("h3",{class:"title"},"模型预报测试结果",-1)),s("div",Et,[a(Q,{"progress-type":"is-dark","pause-text":""},{default:d(()=>[(p(!0),b(N,null,A(o(i).resultList[o(S)].images,(l,m)=>(p(),F(K,{key:m},{default:d(()=>[s("section",null,[s("div",$t,[s("img",{src:l.path.startsWith("http")?l.path:o(L)+l.path,alt:""},null,8,Bt),s("p",null,h(l.date),1)])])]),_:2},1024))),128))]),_:1})])])]),_:1},8,["modelValue"])])}}},Pt=at(Nt,[["__scopeId","data-v-c1f3bb0f"]]);export{Pt as default};
