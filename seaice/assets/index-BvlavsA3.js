import{_ as R,b as x,r as T,w as O,e as Y,f as q,c as V,o as B,a as S,g as z,v as H,h as b,i as k,j as F,u as D,k as W,F as j,l as G,m as X,n as K,t as ee,p as te,q as ae,s as ne}from"./index-Ds_D5mJM.js";import{g as oe,a as re}from"./index-D6yiuLGm.js";const le="/seaice/assets/default-earth-image-CM3n2ZyH.png",se=()=>{const f=[],d=new Date;let a=d.getFullYear(),c=d.getMonth()+1;c++,c>12&&(c=1,a++);for(let r=0;r<12;r++){const o=c<10?`0${c}`:`${c}`;f.push(`${a}-${o}`),c++,c>12&&(c=1,a++)}return f},ie=()=>{const f=[],d=new Date;for(let a=0;a<14;a++){const c=new Date(d);c.setDate(d.getDate()+a),c.getFullYear();const r=c.getMonth()+1,o=c.getDate(),t=r<10?`0${r}`:`${r}`,l=o<10?`0${o}`:`${o}`;f.push(`${t}-${l}`)}return f},ce={class:"cesiumComponentContainer"},ue={class:"controllerContainer"},de={class:"playAndPause"},me={style:{flex:"1",margin:"0 10px"}},ye={__name:"index",props:{initialCoords:{type:Array,default:()=>[-180,-90,180,90]},autoStart:{type:Boolean,default:!0},isPlaying:{type:Boolean,default:!0},switchInterval:{type:Number,default:1500},fetchedUrls:{type:Array,default:()=>[]},dateType:{type:String,default:"daily"}},emits:["handlePlay","handlePause"],setup(f,{expose:d}){let a=window.Cesium;const c=x(),r=f,o=T(null),t={id:null};let l=null;const m=T(0),P=T(null),I=T(null),u=T(null),h=()=>{t.id||(t.id=setInterval(e,r.switchInterval))},y=()=>{t.id&&(clearInterval(t.id),t.id=null)},M=()=>{y(),m.value=0,e(0),h()},e=n=>{let s;n!==void 0?s=n:s=(m.value+1)%r.fetchedUrls.length;const i=A(s%r.fetchedUrls.length),w=i&&i.imageryProvider;try{i.alpha=0,i.show=!1}catch{}_(w,5e3).then(async g=>{try{m.value=s,i.show=!0,u.value.raiseToTop(i),await v(i,0,1,600);try{u.value.remove(I.value,!0)}catch{}I.value=i}catch(U){console.warn("switchToNextImage error during show/animate",U);try{u.value.remove(I.value,!0)}catch{}I.value=i,m.value=s}}).catch(g=>{console.warn("nextLayer provider not ready, fallback,",g),setTimeout(()=>{try{u.value.remove(I.value,!0)}catch{}I.value=i,m.value=s},100)})},p=()=>{m.value=0,I.value=A(m.value)},v=(n,s,i,w=600)=>new Promise(g=>{const U=performance.now(),C=$=>{const E=Math.min(1,($-U)/w),J=s+(i-s)*E;try{n.alpha=J}catch{}E<1?requestAnimationFrame(C):g()};requestAnimationFrame(C)}),_=(n,s=5e3)=>{if(!n||!n.readyPromise)return Promise.resolve();let i=null;return Promise.race([n.readyPromise,new Promise((w,g)=>{i=setTimeout(()=>g(new Error("provider ready timeout")),s)})]).finally(()=>{i&&clearTimeout(i)})},L=async()=>{a.Ion.defaultAccessToken="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1MzQ1NjM4YS03ZGM4LTQ1MDQtOWUwNy01NzVmYmZlMWVkYTEiLCJpZCI6MzQzMzg4LCJpYXQiOjE3NTg1MDU2NTd9.aVcWv4XlIsZ9rCjBah89dQ-g6nf54DSQBzQEzKEQ6uU";const n=new a.SingleTileImageryProvider({url:le,rectangle:a.Rectangle.fromDegrees(...r.initialCoords)});l||(l=document.createElement("div"),l.style.position="absolute",l.style.width="0px",l.style.height="0px",l.style.overflow="hidden",l.style.left="-9999px",l.style.top="-9999px",document.body.appendChild(l)),o.value=new a.Viewer("cesiumContainer",{terrainProvider:a.createWorldTerrain(),timeline:!1,animation:!1,geocoder:!1,homeButton:!1,sceneModePicker:!1,baseLayerPicker:!1,navigationHelpButton:!1,fullscreenButton:!1,imageryProvider:n,creditContainer:l}),u.value=o.value.imageryLayers;const s=o.value.scene.globe.tileLoadProgressEvent.addEventListener(function(g){g===0&&(requestAnimationFrame(function(){c.isLoading=!1,h()}),s())}),i=o.value.entities.add({position:a.Cartesian3.fromDegrees(0,90,0),description:"North Pole Anchor"});o.value.trackedEntity=i;const w=o.value.scene.screenSpaceCameraController;w.enableTilt=!0,w.enableZoom=!0,w.enableRotate=!0,w.constrainedAxis=a.Cartesian3.UNIT_Z;try{P.value=o.value.imageryLayers.get(0)}catch{P.value=null}try{const C=a.Cartesian3.fromDegrees(0,89.5,3e7),$=a.Cartesian3.fromDegrees(0,90,15e6);o.value.camera.setView({destination:C}),await o.value.camera.flyTo({destination:$,orientation:{heading:0,pitch:-Math.PI/2,roll:0},duration:2,easingFunction:a.EasingFunction.QUADRATIC_IN_OUT})}catch{}try{const g=P.value&&P.value.imageryProvider;_(g,5e3).then(()=>{p()})}catch{p()}},A=n=>{if(n<0||n>=r.fetchedUrls.length)return;const s=r.fetchedUrls[n];let i;try{i=u.value.addImageryProvider(new a.SingleTileImageryProvider({url:s,rectangle:a.Rectangle.fromDegrees(-180,-90,180,90)}))}catch(w){console.warn("addImageryProvider error",w)}return i},N=n=>{if(!(typeof n!="number"||n<0||n>r.fetchedUrls.length)){if(!r.isPlaying){e(n);return}y(),e(n),h()}};O(()=>r.isPlaying,n=>{n?h():y()});const Z=Y(()=>r.dateType==="daily"?ie():se());return q(()=>{if(o.value&&!o.value.isDestroyed())try{o.value.destroy()}catch(n){console.warn("destroy viewer error",n)}t.id&&(clearInterval(t.id),t.id=null);try{l&&l.parentNode&&l.parentNode.removeChild(l)}catch{}l=null}),d({initCesium:L,restart:M}),(n,s)=>{const i=k("vue-fontawesome"),w=k("b-slider-tick"),g=k("b-slider"),U=k("b-field");return B(),V("div",ce,[s[3]||(s[3]=S("div",{id:"cesiumContainer"},null,-1)),S("div",ue,[S("div",de,[z(b(i,{onClick:s[0]||(s[0]=C=>n.$emit("handlePlay")),icon:"circle-play",class:"has-text-white",size:"lg"},null,512),[[H,!f.isPlaying]]),z(b(i,{onClick:s[1]||(s[1]=C=>n.$emit("handlePause")),icon:"circle-pause",class:"has-text-white",size:"lg"},null,512),[[H,f.isPlaying]])]),S("section",me,[b(U,null,{default:F(()=>[b(g,{onChange:N,modelValue:D(m),"onUpdate:modelValue":s[2]||(s[2]=C=>W(m)?m.value=C:null),min:0,max:r.fetchedUrls.length||14,ticks:""},{default:F(()=>[(B(!0),V(j,null,G(r.fetchedUrls.length,(C,$)=>(B(),X(w,{key:C,value:C},{default:F(()=>[K(ee(D(Z)[$]),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue","max"])]),_:1})])])])}}},fe=R(ye,[["__scopeId","data-v-fd6f2d80"]]);function Q(f=[],d={}){const{concurrency:a=2,initialBatch:c=3,onProgress:r=null,name:o=""}=d,t=new Array(f.length).fill("pending");let l=!1;const m=(...e)=>{if(typeof r=="function")try{r(...e)}catch(p){console.error("onProgress callback error",p)}},P=new Set;function I(e,{timeoutMs:p=15e3}={}){return e<0||e>=f.length||t[e]==="loaded"||t[e]==="loading"?Promise.resolve():(t[e]="loading",m(e,t[e],o),new Promise(v=>{const _=new Image;P.add(_);let L=null;const A=N=>{L&&(clearTimeout(L),L=null),_.onload=null,_.onerror=null,P.delete(_),v(N)};_.onload=()=>{console.log("loaded",e),t[e]="loaded",m(e,t[e],o),A({index:e,status:"loaded"})},_.onerror=()=>{t[e]="error",m(e,t[e],o),A({index:e,status:"error"})},p>0&&(L=setTimeout(()=>{t[e]="error",m(e,t[e],o),_.onload=null,_.onerror=null;try{_.src=""}catch{}P.delete(_),v({index:e,status:"error",reason:"timeout"})},p)),_.src=f[e]}))}async function u(){if(l)return;const e=Math.min(c,f.length),p=[];for(let v=0;v<e;v++)p.push(I(v));await Promise.all(p),l=!0}async function h(){let e=0;const p=new Array(Math.max(1,a)).fill(0).map(async()=>{for(;;){const v=e++;if(v>=f.length)return;t[v]==="loaded"||t[v]==="error"||await I(v)}});await Promise.all(p)}function y(){for(const e of P)try{e.onload=null,e.onerror=null,e.src=""}catch{}P.clear();for(let e=0;e<t.length;e++)(t[e]==="loading"||t[e]==="pending")&&(t[e]="error",m(e,t[e],o))}function M(){y()}return{urls:f,status:t,get initialLoaded(){return l},loadInitial:u,loadAll:h,cancelAll:y,dispose:M}}const he={class:"realTimeForecastContainer"},ge={__name:"index",setup(f){const d=x(),a=T(null),c=T([]),r=T([]),o=T([]);let t=null,l=null;function m(u,h,y){console.debug(`[preloader:${y}] #${u} -> ${h}`)}const P=async()=>{try{const h=(await oe()||[]).map(y=>y.path||y.url||y);r.value=h,t=Q(h,{concurrency:3,initialBatch:3,onProgress:m,name:"daily"}),await t.loadInitial(),d.dateType==="daily"&&(c.value=r.value)}catch(u){console.error("Failed to fetch daily images:",u)}},I=async()=>{try{const h=(await re()||[]).map(y=>y.path||y.url||y);o.value=h,l=Q(h,{concurrency:2,initialBatch:0,onProgress:m,name:"monthly"}),l.loadAll().then(()=>console.info("monthly preload finished"))}catch(u){console.error("Failed to fetch monthly images:",u)}};return O(()=>d.dateType,async u=>{u==="daily"?c.value=r.value:c.value=o.value,ne().then(()=>{a.value&&a.value.restart()})}),te(async()=>{if(d.isLoading=!0,await Promise.allSettled([P(),I()]),t&&t.loadAll().then(()=>console.info("daily preload finished")),a.value&&typeof a.value.initCesium=="function")try{a.value.initCesium()}catch(u){console.warn("initCesium failed",u)}}),ae(()=>{a.value&&(a.value=null),t&&(t.cancelAll(),t=null)}),(u,h)=>{const y=k("b-tab-item"),M=k("b-tabs"),e=k("b-section"),p=fe;return B(),V("div",he,[b(e,{class:"switcherSection"},{default:F(()=>[b(M,{type:"is-toggle",size:"is-small",modelValue:D(d).dateType,"onUpdate:modelValue":h[0]||(h[0]=v=>D(d).dateType=v)},{default:F(()=>[b(y,{label:"未来14日",value:"daily"}),b(y,{label:"未来12月",value:"monthly"})]),_:1},8,["modelValue"])]),_:1}),b(p,{"date-type":D(d).dateType,"fetched-urls":c.value,onHandlePlay:D(d).play,onHandlePause:D(d).pause,"is-playing":D(d).isPlaying,ref_key:"sphereRef",ref:a},null,8,["date-type","fetched-urls","onHandlePlay","onHandlePause","is-playing"])])}}},we=R(ge,[["__scopeId","data-v-d1798896"]]);export{we as default};
