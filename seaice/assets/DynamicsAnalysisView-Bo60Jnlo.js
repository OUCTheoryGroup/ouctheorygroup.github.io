import{a$ as D,ah as z,l as _e,b1 as Ve,aO as Me,z as Ne,k as de,A as xe,m as Ie,r as k,aV as Q,C as P,aY as X,U as R,o as ce,bf as Ee,c as I,d as _,a8 as oe,D as $,b,f as i,al as q,E as te,p as H,w as x,e as J,b4 as we,bk as ke,J as re,bl as Se,aE as $e,ab as Ce,am as L,az as ue,R as Ae,b0 as De,af as Ye,_ as ne,a as v,aj as Fe,ak as Pe,F as w,K as Z,bi as Ue,aC as le,L as Oe,aG as F,bm as ze,bn as Le}from"./index-BCSuCmXA.js";import{E as Re,a as Ke,b as Ge,d as je,e as We}from"./el-radio-PfqD2juK.js";import{U,I as T,C as me,g as Be,d as Xe,a as qe,v as ie,k as He,l as Je,E as Qe,c as Te}from"./el-button-D0LLwSBC.js";import{g as ae,E as Ze}from"./util-BhyXcBt8.js";const et=_e({id:{type:String,default:void 0},step:{type:Number,default:1},stepStrictly:Boolean,max:{type:Number,default:Number.POSITIVE_INFINITY},min:{type:Number,default:Number.NEGATIVE_INFINITY},modelValue:Number,readonly:Boolean,disabled:Boolean,size:Me,controls:{type:Boolean,default:!0},controlsPosition:{type:String,default:"",values:["","right"]},valueOnClear:{type:[String,Number,null],validator:p=>p===null||D(p)||["min","max"].includes(p),default:null},name:String,placeholder:String,precision:{type:Number,validator:p=>p>=0&&p===Number.parseInt(`${p}`,10)},validateEvent:{type:Boolean,default:!0},...Ve(["ariaLabel"])}),tt={[me]:(p,n)=>n!==p,blur:p=>p instanceof FocusEvent,focus:p=>p instanceof FocusEvent,[T]:p=>D(p)||z(p),[U]:p=>D(p)||z(p)},lt=de({name:"ElInputNumber"}),at=de({...lt,props:et,emits:tt,setup(p,{expose:n,emit:h}){const o=p,{t:g}=xe(),f=Ie("input-number"),y=k(),l=Q({currentValue:o.modelValue,userInput:null}),{formItem:t}=Be(),C=P(()=>D(o.modelValue)&&o.modelValue<=o.min),d=P(()=>D(o.modelValue)&&o.modelValue>=o.max),a=P(()=>{const e=K(o.step);return X(o.precision)?Math.max(K(o.modelValue),e):(e>o.precision,o.precision)}),c=P(()=>o.controls&&o.controlsPosition==="right"),r=Xe(),u=qe(),S=P(()=>{if(l.userInput!==null)return l.userInput;let e=l.currentValue;if(z(e))return"";if(D(e)){if(Number.isNaN(e))return"";X(o.precision)||(e=e.toFixed(o.precision))}return e}),Y=(e,s)=>{if(X(s)&&(s=a.value),s===0)return Math.round(e);let m=String(e);const V=m.indexOf(".");if(V===-1||!m.replace(".","").split("")[V+s])return e;const W=m.length;return m.charAt(W-1)==="5"&&(m=`${m.slice(0,Math.max(0,W-1))}6`),Number.parseFloat(Number(m).toFixed(s))},K=e=>{if(z(e))return 0;const s=e.toString(),m=s.indexOf(".");let V=0;return m!==-1&&(V=s.length-m-1),V},G=(e,s=1)=>D(e)?Y(e+o.step*s):l.currentValue,O=()=>{if(o.readonly||u.value||d.value)return;const e=Number(S.value)||0,s=G(e);j(s),h(T,l.currentValue),ee()},N=()=>{if(o.readonly||u.value||C.value)return;const e=Number(S.value)||0,s=G(e,-1);j(s),h(T,l.currentValue),ee()},se=(e,s)=>{const{max:m,min:V,step:M,precision:A,stepStrictly:W,valueOnClear:B}=o;m<V&&Ae("InputNumber","min should not be greater than max.");let E=Number(e);if(z(e)||Number.isNaN(E))return null;if(e===""){if(B===null)return null;E=De(B)?{min:V,max:m}[B]:B}return W&&(E=Y(Math.round(E/M)*M,A),E!==e&&s&&h(U,E)),X(A)||(E=Y(E,A)),(E>m||E<V)&&(E=E>m?m:V,s&&h(U,E)),E},j=(e,s=!0)=>{var m;const V=l.currentValue,M=se(e);if(!s){h(U,M);return}V===M&&e||(l.userInput=null,h(U,M),V!==M&&h(me,M,V),o.validateEvent&&((m=t==null?void 0:t.validate)==null||m.call(t,"change").catch(A=>ue())),l.currentValue=M)},pe=e=>{l.userInput=e;const s=e===""?null:Number(e);h(T,s),j(s,!1)},fe=e=>{const s=e!==""?Number(e):"";(D(s)&&!Number.isNaN(s)||e==="")&&j(s),ee(),l.userInput=null},ve=()=>{var e,s;(s=(e=y.value)==null?void 0:e.focus)==null||s.call(e)},he=()=>{var e,s;(s=(e=y.value)==null?void 0:e.blur)==null||s.call(e)},ge=e=>{h("focus",e)},be=e=>{var s,m;l.userInput=null,Je()&&l.currentValue===null&&((s=y.value)!=null&&s.input)&&(y.value.input.value=""),h("blur",e),o.validateEvent&&((m=t==null?void 0:t.validate)==null||m.call(t,"blur").catch(V=>ue()))},ee=()=>{l.currentValue!==o.modelValue&&(l.currentValue=o.modelValue)},ye=e=>{document.activeElement===e.target&&e.preventDefault()};return R(()=>o.modelValue,(e,s)=>{const m=se(e,!0);l.userInput===null&&m!==s&&(l.currentValue=m)},{immediate:!0}),ce(()=>{var e;const{min:s,max:m,modelValue:V}=o,M=(e=y.value)==null?void 0:e.input;if(M.setAttribute("role","spinbutton"),Number.isFinite(m)?M.setAttribute("aria-valuemax",String(m)):M.removeAttribute("aria-valuemax"),Number.isFinite(s)?M.setAttribute("aria-valuemin",String(s)):M.removeAttribute("aria-valuemin"),M.setAttribute("aria-valuenow",l.currentValue||l.currentValue===0?String(l.currentValue):""),M.setAttribute("aria-disabled",String(u.value)),!D(V)&&V!=null){let A=Number(V);Number.isNaN(A)&&(A=null),h(U,A)}M.addEventListener("wheel",ye,{passive:!1})}),Ee(()=>{var e,s;const m=(e=y.value)==null?void 0:e.input;m==null||m.setAttribute("aria-valuenow",`${(s=l.currentValue)!=null?s:""}`)}),n({focus:ve,blur:he}),(e,s)=>(_(),I("div",{class:te([i(f).b(),i(f).m(i(r)),i(f).is("disabled",i(u)),i(f).is("without-controls",!e.controls),i(f).is("controls-right",i(c))]),onDragstart:L(()=>{},["prevent"])},[e.controls?oe((_(),I("span",{key:0,role:"button","aria-label":i(g)("el.inputNumber.decrease"),class:te([i(f).e("decrease"),i(f).is("disabled",i(C))]),onKeydown:q(N,["enter"])},[H(e.$slots,"decrease-icon",{},()=>[b(i(re),null,{default:x(()=>[i(c)?(_(),J(i(we),{key:0})):(_(),J(i(ke),{key:1}))]),_:1})])],42,["aria-label","onKeydown"])),[[i(ie),N]]):$("v-if",!0),e.controls?oe((_(),I("span",{key:1,role:"button","aria-label":i(g)("el.inputNumber.increase"),class:te([i(f).e("increase"),i(f).is("disabled",i(d))]),onKeydown:q(O,["enter"])},[H(e.$slots,"increase-icon",{},()=>[b(i(re),null,{default:x(()=>[i(c)?(_(),J(i(Se),{key:0})):(_(),J(i($e),{key:1}))]),_:1})])],42,["aria-label","onKeydown"])),[[i(ie),O]]):$("v-if",!0),b(i(He),{id:e.id,ref_key:"input",ref:y,type:"number",step:e.step,"model-value":i(S),placeholder:e.placeholder,readonly:e.readonly,disabled:i(u),size:i(r),max:e.max,min:e.min,name:e.name,"aria-label":e.ariaLabel,"validate-event":!1,onKeydown:[q(L(O,["prevent"]),["up"]),q(L(N,["prevent"]),["down"])],onBlur:be,onFocus:ge,onInput:pe,onChange:fe},Ce({_:2},[e.$slots.prefix?{name:"prefix",fn:x(()=>[H(e.$slots,"prefix")])}:void 0,e.$slots.suffix?{name:"suffix",fn:x(()=>[H(e.$slots,"suffix")])}:void 0]),1032,["id","step","model-value","placeholder","readonly","disabled","size","max","min","name","aria-label","onKeydown"])],42,["onDragstart"]))}});var nt=Ne(at,[["__file","input-number.vue"]]);const st=Ye(nt),ot={class:"dynamics-viewer"},rt={class:"image-container"},ut={key:0,class:"loading-overlay"},it=["src","alt","onClick","onLoad"],dt={class:"image-date-label"},ct={key:0,class:"empty-state"},mt=["src"],pt={class:"image-date"},ft={__name:"DynamicsAnalysisViewer",props:{images:{type:Array,required:!0}},setup(p){const n=p,h=k(null),o=k(1),g=k([]),f=P(()=>!n.images||n.images.length===0?1:Math.ceil(n.images.length/2)),y=a=>new Promise((c,r)=>{const u=new Image;u.onload=()=>c(),u.onerror=r,u.src=a}),l=()=>{!n.images||n.images.length===0||n.images.forEach((a,c)=>{y(ae(a.path)).then(()=>{g.value[c]=!1}).catch(r=>{console.error(`Failed to load image: ${a.path}`,r),g.value[c]=!1})})};R(()=>n.images,a=>{a&&a.length>0&&(g.value=new Array(a.length).fill(!0),l())},{immediate:!0});const t=a=>{g.value[a]=!1},C=a=>{a&&(h.value=a,o.value=1)},d=a=>{const c=Math.sign(a.deltaY),r=Math.max(1,Math.min(3,o.value-c*.2));o.value=r,a.preventDefault()};return ce(()=>{l()}),(a,c)=>(_(),I("div",ot,[c[4]||(c[4]=v("h2",{class:"section-title"},"动力学分析结果热图",-1)),v("div",{class:"image-grid",style:Z({"--images-per-row":f.value})},[(_(!0),I(Fe,null,Pe(p.images,(r,u)=>(_(),I("div",{key:u,class:"image-card"},[v("div",rt,[g.value[u]?(_(),I("div",ut,c[2]||(c[2]=[v("div",{class:"loading-spinner"},null,-1)]))):$("",!0),v("img",{src:i(ae)(r.path),alt:`${r.date} - 动力学分析结果`,class:"analysis-image",onClick:S=>C(r),onLoad:S=>t(u)},null,40,it)]),v("div",dt,w(r.date),1)]))),128))],4),!p.images||p.images.length===0?(_(),I("div",ct,[b(i(Ze),{description:"暂无分析结果"})])):$("",!0),h.value?(_(),I("div",{key:1,class:"modal-overlay",onWheel:d,onClick:c[1]||(c[1]=L(r=>h.value=null,["self"]))},[v("div",{class:"modal-content",style:Z({transform:`scale(${o.value})`})},[v("img",{src:i(ae)(h.value.path),alt:"放大查看",class:"modal-image"},null,8,mt),v("p",pt,w(h.value.date),1)],4),v("button",{onClick:c[0]||(c[0]=r=>h.value=null),class:"close-button"},c[3]||(c[3]=[v("svg",{class:"close-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[v("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]))],32)):$("",!0)]))}},vt=ne(ft,[["__scopeId","data-v-e77b7c64"]]),ht="/seaice/picture/land_image.webp",gt={class:"image-selector"},bt={key:0,class:"selection-info-container"},yt={class:"selection-info"},_t={__name:"ImageSelector",props:{topLeft:{type:Object,default:()=>({x:null,y:null})},bottomRight:{type:Object,default:()=>({x:null,y:null})}},emits:["update:topLeft","update:bottomRight"],setup(p,{emit:n}){const h=p,o=n,g=k(null),f=k(!1),y=Q({x:0,y:0}),l=Q({left:0,top:0,width:0,height:0}),t=Q({left:0,top:0,width:0,height:0,isVisible:!1}),C=r=>{r.preventDefault(),f.value=!0;const u=g.value.getBoundingClientRect();y.x=r.clientX-u.left,y.y=r.clientY-u.top,l.left=y.x,l.top=y.y,l.width=0,l.height=0},d=r=>{if(!f.value)return;const u=g.value.getBoundingClientRect(),S=Math.min(Math.max(r.clientX-u.left,0),u.width),Y=Math.min(Math.max(r.clientY-u.top,0),u.height);l.left=Math.min(S,y.x),l.top=Math.min(Y,y.y),l.width=Math.abs(S-y.x),l.height=Math.abs(Y-y.y)},a=()=>{f.value=!1,l.width>0&&l.height>0&&(t.left=l.left,t.top=l.top,t.width=l.width,t.height=l.height,t.isVisible=!0,o("update:topLeft",{x:Math.round(t.left),y:Math.round(t.top)}),o("update:bottomRight",{x:Math.round(t.left+t.width),y:Math.round(t.top+t.height)}))};R(()=>[h.topLeft,h.bottomRight],([r,u])=>{(r==null?void 0:r.x)!==null&&(r==null?void 0:r.y)!==null&&(u==null?void 0:u.x)!==null&&(u==null?void 0:u.y)!==null?(t.left=r.x,t.top=r.y,t.width=u.x-r.x,t.height=u.y-r.y,t.isVisible=!0):t.isVisible=!1},{immediate:!0});const c=()=>{t.left=0,t.top=0,t.width=0,t.height=0,t.isVisible=!1,l.left=0,l.top=0,l.width=0,l.height=0,o("update:topLeft",{x:null,y:null}),o("update:bottomRight",{x:null,y:null})};return(r,u)=>(_(),I("div",gt,[v("div",{class:"image-container",ref_key:"imageContainer",ref:g,onMousedown:C,onMousemove:d,onMouseup:a,onMouseleave:a},[u[0]||(u[0]=v("img",{src:ht,alt:"Selectable Image",draggable:"false"},null,-1)),f.value?(_(),I("div",{key:0,class:"selection",style:Z({left:`${l.left}px`,top:`${l.top}px`,width:`${l.width}px`,height:`${l.height}px`})},null,4)):$("",!0),t.isVisible?(_(),I("div",{key:1,class:"last-selection",style:Z({left:`${t.left}px`,top:`${t.top}px`,width:`${t.width}px`,height:`${t.height}px`})},null,4)):$("",!0)],544),t.isVisible?(_(),I("div",bt,[v("div",yt,[u[1]||(u[1]=v("p",null,"最后选择区域尺寸:",-1)),v("p",null,"宽度: "+w(Math.round(t.width))+"px",1),v("p",null,"高度: "+w(Math.round(t.height))+"px",1),u[2]||(u[2]=v("p",null,"角坐标:",-1)),v("p",null,"左上: ("+w(Math.round(t.left))+", "+w(Math.round(t.top))+")",1),v("p",null," 右上: ("+w(Math.round(t.left+t.width))+", "+w(Math.round(t.top))+") ",1),v("p",null," 左下: ("+w(Math.round(t.left))+", "+w(Math.round(t.top+t.height))+") ",1),v("p",null," 右下: ("+w(Math.round(t.left+t.width))+", "+w(Math.round(t.top+t.height))+") ",1)]),v("button",{class:"clear-button",onClick:c},"清除选择")])):$("",!0)]))}},Vt=ne(_t,[["__scopeId","data-v-e1376212"]]),Mt={class:"container-layout"},Nt={class:"main-content"},xt={key:0,class:"loading-container"},It={key:1,class:"result-section"},Et={__name:"DynamicsAnalysisView",setup(p){const n=k({startMonth:"",endMonth:"",grad_forecast_month:1,grad_month:"",grad_lat_lon:"",grad_type:"sum",x1:null,y1:null,x2:null,y2:null}),h=k([]),o=k(!1),g=k(!1),f=k(null),y=k({x:null,y:null}),l=k({x:null,y:null});R([y,l],([d,a])=>{n.value.x1=d.y,n.value.y1=d.x,n.value.x2=a.y,n.value.y2=a.x},{immediate:!0,deep:!0}),R([()=>n.value.endMonth,()=>n.value.grad_forecast_month],([d,a])=>{if(d&&a){const c=new Date(d.substring(0,4),parseInt(d.substring(4))-1);c.setMonth(c.getMonth()+a),n.value.grad_month=String(c.getMonth()+1).padStart(2,"0")}else n.value.grad_month=""});const t=async()=>{if(f.value)try{const d=await Le(f.value);d.success&&d.status==="COMPLETED"?(h.value=d.data.images,o.value=!0,F.success(d.message||"分析完成"),g.value=!1,f.value=null):d.status==="IN_PROGRESS"?console.log("Task not completed yet, continuing polling..."):d.status==="FAILED"&&(console.error("分析任务失败:",d.message),g.value=!1,o.value=!1,F.error(d.message||"分析任务失败"),f.value=null)}catch(d){console.error("轮询分析结果出错:",d),g.value=!1,o.value=!1,F.error("获取分析结果失败"),f.value=null}},C=async()=>{if(!n.value.startMonth||!n.value.endMonth||!n.value.grad_month||!n.value.grad_forecast_month){F.error("请填写完整的分析参数");return}try{g.value=!0,o.value=!1;const d=await ze(n.value.startMonth,n.value.endMonth,n.value.grad_type,n.value.grad_month,n.value.x1,n.value.y1,n.value.x2,n.value.y2);if(d.success)f.value=d.data.task_id;else{g.value=!1,F.error(d.message||"提交分析请求失败");return}const a=setInterval(async()=>{await t(),g.value||clearInterval(a)},2e3)}catch(d){o.value=!1,g.value=!1,F.error("提交分析请求失败，请重试"),console.error("Analysis error:",d)}};return Ue(()=>{f.value&&(f.value=null)}),(d,a)=>{const c=Qe,r=Ge,u=st,S=We,Y=je,K=Te,G=Ke,O=Re;return _(),I("div",Mt,[v("div",Nt,[b(O,{class:"box-card"},{default:x(()=>[b(G,{model:n.value,onSubmit:L(C,["prevent"]),class:"analysis-form"},{default:x(()=>[b(r,{label:"开始月份"},{default:x(()=>[b(c,{modelValue:n.value.startMonth,"onUpdate:modelValue":a[0]||(a[0]=N=>n.value.startMonth=N),type:"month",placeholder:"选择开始月份",format:"YYYY-MM","value-format":"YYYYMM"},null,8,["modelValue"])]),_:1}),b(r,{label:"结束月份"},{default:x(()=>[b(c,{modelValue:n.value.endMonth,"onUpdate:modelValue":a[1]||(a[1]=N=>n.value.endMonth=N),type:"month",placeholder:"选择结束月份",format:"YYYY-MM","value-format":"YYYYMM"},null,8,["modelValue"])]),_:1}),b(r,{label:"预报提前期"},{default:x(()=>[b(u,{modelValue:n.value.grad_forecast_month,"onUpdate:modelValue":a[2]||(a[2]=N=>n.value.grad_forecast_month=N),min:1,placeholder:"请输入提前期（月）"},null,8,["modelValue"])]),_:1}),b(r,{label:"目标月份"},{default:x(()=>[b(c,{modelValue:n.value.grad_month,"onUpdate:modelValue":a[3]||(a[3]=N=>n.value.grad_month=N),type:"month",placeholder:"目标月份由数据范围和预报提前期决定",format:"MM","value-format":"MM",disabled:""},null,8,["modelValue"])]),_:1}),b(r,{label:"分析范围"},{default:x(()=>[b(Vt,{topLeft:y.value,"onUpdate:topLeft":a[4]||(a[4]=N=>y.value=N),bottomRight:l.value,"onUpdate:bottomRight":a[5]||(a[5]=N=>l.value=N)},null,8,["topLeft","bottomRight"])]),_:1}),b(r,{label:"分析目标"},{default:x(()=>[b(Y,{modelValue:n.value.grad_type,"onUpdate:modelValue":a[6]||(a[6]=N=>n.value.grad_type=N)},{default:x(()=>[b(S,{value:"sum"},{default:x(()=>a[7]||(a[7]=[le("海冰面积")])),_:1}),b(S,{value:"variation"},{default:x(()=>a[8]||(a[8]=[le("海冰变化")])),_:1})]),_:1},8,["modelValue"])]),_:1}),b(r,null,{default:x(()=>[b(K,{type:"primary",loading:g.value,onClick:C},{default:x(()=>[le(w(g.value?"分析中...":"提交分析"),1)]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"]),g.value?(_(),I("div",xt,[b(Oe)])):$("",!0),!g.value&&o.value?(_(),I("div",It,[b(vt,{images:h.value,class:"full-width"},null,8,["images"])])):$("",!0)]),_:1})])])}}},Ct=ne(Et,[["__scopeId","data-v-c2285b4d"]]);export{Ct as default};
