import{_ as D,r as v,v as N,O as Y,o as B,c as y,b as g,y as m,z as b,B as _,an as q,ao as O,u as I,F as C,a as s,aq as L,aC as T,aI as z,w as u,aD as k,aF as j,L as G}from"./index-Z0nRmrsO.js";import{E as W,a as K,b as H,c as J,I as Q,d as X,e as Z}from"./ImageSelector-CRxmkqyp.js";import{d as E,e as x,E as ee,f as h,h as ae,j as le}from"./api-BOsx9nvd.js";const se={class:"dynamics-viewer"},te={class:"section-title"},ne={class:"image-container"},oe={key:0,class:"loading-overlay"},re=["src","alt","onClick","onLoad"],ie={class:"image-date-label"},ue={key:0,class:"empty-state"},de=["src","alt"],me={class:"image-date"},ce={__name:"DynamicsAnalysisViewer",props:{images:{type:Array,required:!0}},setup(A){const o=A,a=v(null),f=v(1),d=v([]),r=N(()=>!o.images||o.images.length===0?1:Math.ceil(o.images.length/2)),c=e=>new Promise((l,t)=>{const n=new Image;n.onload=()=>l(),n.onerror=t,n.src=e}),p=()=>{!o.images||o.images.length===0||o.images.forEach((e,l)=>{c(E(e.path)).then(()=>{d.value[l]=!1}).catch(t=>{console.error(`Failed to load image: ${e.path}`,t),d.value[l]=!1})})};Y(()=>o.images,e=>{e&&e.length>0&&(d.value=new Array(e.length).fill(!0),p())},{immediate:!0});const M=e=>{d.value[e]=!1},$=e=>{e&&(a.value=e,f.value=1)},V=e=>{const l=Math.sign(e.deltaY),t=Math.max(1,Math.min(3,f.value-l*.2));f.value=t,e.preventDefault()};return B(()=>{p()}),(e,l)=>(g(),y("div",se,[m("h2",te,_(e.$t("dynamicsAnalysisViewer.title")),1),m("div",{class:"image-grid",style:C({"--images-per-row":r.value})},[(g(!0),y(q,null,O(A.images,(t,n)=>(g(),y("div",{key:n,class:"image-card"},[m("div",ne,[d.value[n]?(g(),y("div",oe,l[2]||(l[2]=[m("div",{class:"loading-spinner"},null,-1)]))):b("",!0),m("img",{src:I(E)(t.path),alt:e.$t("dynamicsAnalysisViewer.imageAlt",{date:t.date}),class:"analysis-image",onClick:w=>$(t),onLoad:w=>M(n)},null,40,re)]),m("div",ie,_(t.date),1)]))),128))],4),!A.images||A.images.length===0?(g(),y("div",ue,[s(I(x),{description:e.$t("dynamicsAnalysisViewer.noResults")},null,8,["description"])])):b("",!0),a.value?(g(),y("div",{key:1,class:"modal-overlay",onWheel:V,onClick:l[1]||(l[1]=L(t=>a.value=null,["self"]))},[m("div",{class:"modal-content",style:C({transform:`scale(${f.value})`})},[m("img",{src:I(E)(a.value.path),alt:e.$t("dynamicsAnalysisViewer.modalImageAlt"),class:"modal-image"},null,8,de),m("p",me,_(a.value.date),1)],4),m("button",{onClick:l[0]||(l[0]=t=>a.value=null),class:"close-button"},l[3]||(l[3]=[m("svg",{class:"close-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[m("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]))],32)):b("",!0)]))}},ve=D(ce,[["__scopeId","data-v-e7b3f120"]]),ye={class:"container-layout"},ge={key:0,class:"loading-container"},fe={key:1,class:"result-section"},pe={__name:"DynamicsAnalysisView",setup(A){const{t:o}=T(),a=v({startMonth:"",endMonth:"",grad_forecast_month:1,grad_month:"",grad_lat_lon:"",grad_type:"sum",x1:null,y1:null,x2:null,y2:null}),f=v([]),d=v(!1),r=v(!1),c=v(null),p=v({x:null,y:null}),M=v({x:null,y:null});Y([p,M],([e,l])=>{a.value.x1=e.y,a.value.y1=e.x,a.value.x2=l.y,a.value.y2=l.x},{immediate:!0,deep:!0}),Y([()=>a.value.endMonth,()=>a.value.grad_forecast_month],([e,l])=>{if(e&&l){const t=new Date(e.substring(0,4),parseInt(e.substring(4))-1);t.setMonth(t.getMonth()+l),a.value.grad_month=String(t.getMonth()+1).padStart(2,"0")}else a.value.grad_month=""});const $=async()=>{if(c.value)try{const e=await le(c.value);e.success&&e.status==="COMPLETED"?(f.value=e.data.images,d.value=!0,h.success(e.message||o("dynamicsAnalysis.analysisComplete")),r.value=!1,c.value=null):e.status==="IN_PROGRESS"?console.log("Task not completed yet, continuing polling..."):e.status==="FAILED"&&(console.error("分析任务失败:",e.message),r.value=!1,d.value=!1,h.error(e.message||o("dynamicsAnalysis.taskFailed")),c.value=null)}catch(e){console.error("轮询分析结果出错:",e),r.value=!1,d.value=!1,h.error(o("dynamicsAnalysis.getResultsFailed")),c.value=null}},V=async()=>{if(!a.value.startMonth||!a.value.endMonth||!a.value.grad_month||!a.value.grad_forecast_month){h.error(o("dynamicsAnalysis.fillCompleteParams"));return}try{r.value=!0,d.value=!1;const e=await ae(a.value.startMonth,a.value.endMonth,a.value.grad_type,a.value.grad_month,a.value.x1,a.value.y1,a.value.x2,a.value.y2);if(e.success)c.value=e.data.task_id;else{r.value=!1,h.error(e.message||o("dynamicsAnalysis.submitRequestFailed"));return}const l=setInterval(async()=>{await $(),r.value||clearInterval(l)},2e3)}catch(e){d.value=!1,r.value=!1,h.error(o("dynamicsAnalysis.submitRequestFailedRetry")),console.error("Analysis error:",e)}};return z(()=>{c.value&&(c.value=null)}),(e,l)=>{const t=ee,n=H,w=J,R=Z,F=X,P=j,S=K,U=W;return g(),y("div",ye,[s(U,{class:"box-card"},{default:u(()=>[s(S,{model:a.value,onSubmit:L(V,["prevent"]),class:"analysis-form"},{default:u(()=>[s(n,{label:e.$t("dynamicsAnalysis.startMonth")},{default:u(()=>[s(t,{modelValue:a.value.startMonth,"onUpdate:modelValue":l[0]||(l[0]=i=>a.value.startMonth=i),type:"month",placeholder:e.$t("dynamicsAnalysis.selectStartMonth"),format:"YYYY-MM","value-format":"YYYYMM"},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),s(n,{label:e.$t("dynamicsAnalysis.endMonth")},{default:u(()=>[s(t,{modelValue:a.value.endMonth,"onUpdate:modelValue":l[1]||(l[1]=i=>a.value.endMonth=i),type:"month",placeholder:e.$t("dynamicsAnalysis.selectEndMonth"),format:"YYYY-MM","value-format":"YYYYMM"},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),s(n,{label:e.$t("dynamicsAnalysis.forecastPeriod")},{default:u(()=>[s(w,{modelValue:a.value.grad_forecast_month,"onUpdate:modelValue":l[2]||(l[2]=i=>a.value.grad_forecast_month=i),min:1,placeholder:e.$t("dynamicsAnalysis.forecastPeriodPlaceholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),s(n,{label:e.$t("dynamicsAnalysis.targetMonth")},{default:u(()=>[s(t,{modelValue:a.value.grad_month,"onUpdate:modelValue":l[3]||(l[3]=i=>a.value.grad_month=i),type:"month",placeholder:e.$t("dynamicsAnalysis.targetMonthPlaceholder"),format:"MM","value-format":"MM",disabled:""},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),s(n,{label:e.$t("dynamicsAnalysis.analysisRange")},{default:u(()=>[s(Q,{topLeft:p.value,"onUpdate:topLeft":l[4]||(l[4]=i=>p.value=i),bottomRight:M.value,"onUpdate:bottomRight":l[5]||(l[5]=i=>M.value=i)},null,8,["topLeft","bottomRight"])]),_:1},8,["label"]),s(n,{label:e.$t("dynamicsAnalysis.analysisTarget")},{default:u(()=>[s(F,{modelValue:a.value.grad_type,"onUpdate:modelValue":l[6]||(l[6]=i=>a.value.grad_type=i)},{default:u(()=>[s(R,{value:"sum"},{default:u(()=>[k(_(e.$t("dynamicsAnalysis.seaIceArea")),1)]),_:1}),s(R,{value:"variation"},{default:u(()=>[k(_(e.$t("dynamicsAnalysis.seaIceVariation")),1)]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["label"]),s(n,null,{default:u(()=>[s(P,{type:"primary",loading:r.value,onClick:V},{default:u(()=>[k(_(r.value?e.$t("dynamicsAnalysis.analyzing"):e.$t("dynamicsAnalysis.submitAnalysis")),1)]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"]),r.value?(g(),y("div",ge,[s(G)])):b("",!0),!r.value&&d.value?(g(),y("div",fe,[s(ve,{images:f.value,class:"full-width"},null,8,["images"])])):b("",!0)]),_:1})])}}},Me=D(pe,[["__scopeId","data-v-a38ef59b"]]);export{Me as default};
