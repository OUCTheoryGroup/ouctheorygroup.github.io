import{_ as A,r as M,C as L,U as Y,o as O,c as f,d as _,a as u,D as b,aj as P,ak as j,f as E,F as g,K as C,b as d,am as U,aV as S,bi as G,w as h,aC as w,L as X,aG as $,bk as K,bl as W}from"./index-BZYb-IDk.js";import{E as q,a as z,b as H,d as J,e as Q}from"./el-radio-Bwh9qyKW.js";import{E as Z,c as B}from"./el-button-3s8mayEW.js";import{E as T}from"./el-input-number-BLuiG25O.js";import{g as D,E as ee}from"./util-YujQlNxc.js";const te={class:"dynamics-viewer"},le={class:"image-container"},ae={key:0,class:"loading-overlay"},se=["src","alt","onClick","onLoad"],oe={class:"image-date-label"},ne={key:0,class:"empty-state"},ie=["src"],ue={class:"image-date"},re={__name:"DynamicsAnalysisViewer",props:{images:{type:Array,required:!0}},setup(x){const l=x,y=M(null),c=M(1),r=M([]),m=L(()=>!l.images||l.images.length===0?1:Math.ceil(l.images.length/2)),v=e=>new Promise((i,a)=>{const s=new Image;s.onload=()=>i(),s.onerror=a,s.src=e}),o=()=>{!l.images||l.images.length===0||l.images.forEach((e,i)=>{v(D(e.path)).then(()=>{r.value[i]=!1}).catch(a=>{console.error(`Failed to load image: ${e.path}`,a),r.value[i]=!1})})};Y(()=>l.images,e=>{e&&e.length>0&&(r.value=new Array(e.length).fill(!0),o())},{immediate:!0});const t=e=>{r.value[e]=!1},k=e=>{e&&(y.value=e,c.value=1)},n=e=>{const i=Math.sign(e.deltaY),a=Math.max(1,Math.min(3,c.value-i*.2));c.value=a,e.preventDefault()};return O(()=>{o()}),(e,i)=>(_(),f("div",te,[i[4]||(i[4]=u("h2",{class:"section-title"},"动力学分析结果热图",-1)),u("div",{class:"image-grid",style:C({"--images-per-row":m.value})},[(_(!0),f(P,null,j(x.images,(a,s)=>(_(),f("div",{key:s,class:"image-card"},[u("div",le,[r.value[s]?(_(),f("div",ae,i[2]||(i[2]=[u("div",{class:"loading-spinner"},null,-1)]))):b("",!0),u("img",{src:E(D)(a.path),alt:`${a.date} - 动力学分析结果`,class:"analysis-image",onClick:V=>k(a),onLoad:V=>t(s)},null,40,se)]),u("div",oe,g(a.date),1)]))),128))],4),!x.images||x.images.length===0?(_(),f("div",ne,[d(E(ee),{description:"暂无分析结果"})])):b("",!0),y.value?(_(),f("div",{key:1,class:"modal-overlay",onWheel:n,onClick:i[1]||(i[1]=U(a=>y.value=null,["self"]))},[u("div",{class:"modal-content",style:C({transform:`scale(${c.value})`})},[u("img",{src:E(D)(y.value.path),alt:"放大查看",class:"modal-image"},null,8,ie),u("p",ue,g(y.value.date),1)],4),u("button",{onClick:i[0]||(i[0]=a=>y.value=null),class:"close-button"},i[3]||(i[3]=[u("svg",{class:"close-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[u("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]))],32)):b("",!0)]))}},de=A(re,[["__scopeId","data-v-3dd3c4e2"]]),ce="/seaice/picture/land_image.webp",me={class:"image-selector"},ve={key:0,class:"selection-info-container"},pe={class:"selection-info"},he={__name:"ImageSelector",props:{topLeft:{type:Object,default:()=>({x:null,y:null})},bottomRight:{type:Object,default:()=>({x:null,y:null})}},emits:["update:topLeft","update:bottomRight"],setup(x,{emit:l}){const y=x,c=l,r=M(null),m=M(!1),v=S({x:0,y:0}),o=S({left:0,top:0,width:0,height:0}),t=S({left:0,top:0,width:0,height:0,isVisible:!1}),k=a=>{a.preventDefault(),m.value=!0;const s=r.value.getBoundingClientRect();v.x=a.clientX-s.left,v.y=a.clientY-s.top,o.left=v.x,o.top=v.y,o.width=0,o.height=0},n=a=>{if(!m.value)return;const s=r.value.getBoundingClientRect(),V=Math.min(Math.max(a.clientX-s.left,0),s.width),I=Math.min(Math.max(a.clientY-s.top,0),s.height);o.left=Math.min(V,v.x),o.top=Math.min(I,v.y),o.width=Math.abs(V-v.x),o.height=Math.abs(I-v.y)},e=()=>{m.value=!1,o.width>0&&o.height>0&&(t.left=o.left,t.top=o.top,t.width=o.width,t.height=o.height,t.isVisible=!0,c("update:topLeft",{x:Math.round(t.left),y:Math.round(t.top)}),c("update:bottomRight",{x:Math.round(t.left+t.width),y:Math.round(t.top+t.height)}))};Y(()=>[y.topLeft,y.bottomRight],([a,s])=>{(a==null?void 0:a.x)!==null&&(a==null?void 0:a.y)!==null&&(s==null?void 0:s.x)!==null&&(s==null?void 0:s.y)!==null?(t.left=a.x,t.top=a.y,t.width=s.x-a.x,t.height=s.y-a.y,t.isVisible=!0):t.isVisible=!1},{immediate:!0});const i=()=>{t.left=0,t.top=0,t.width=0,t.height=0,t.isVisible=!1,o.left=0,o.top=0,o.width=0,o.height=0,c("update:topLeft",{x:null,y:null}),c("update:bottomRight",{x:null,y:null})};return(a,s)=>(_(),f("div",me,[u("div",{class:"image-container",ref_key:"imageContainer",ref:r,onMousedown:k,onMousemove:n,onMouseup:e,onMouseleave:e},[s[0]||(s[0]=u("img",{src:ce,alt:"Selectable Image",draggable:"false"},null,-1)),m.value?(_(),f("div",{key:0,class:"selection",style:C({left:`${o.left}px`,top:`${o.top}px`,width:`${o.width}px`,height:`${o.height}px`})},null,4)):b("",!0),t.isVisible?(_(),f("div",{key:1,class:"last-selection",style:C({left:`${t.left}px`,top:`${t.top}px`,width:`${t.width}px`,height:`${t.height}px`})},null,4)):b("",!0)],544),t.isVisible?(_(),f("div",ve,[u("div",pe,[s[1]||(s[1]=u("p",null,"最后选择区域尺寸:",-1)),u("p",null,"宽度: "+g(Math.round(t.width))+"px",1),u("p",null,"高度: "+g(Math.round(t.height))+"px",1),s[2]||(s[2]=u("p",null,"角坐标:",-1)),u("p",null,"左上: ("+g(Math.round(t.left))+", "+g(Math.round(t.top))+")",1),u("p",null," 右上: ("+g(Math.round(t.left+t.width))+", "+g(Math.round(t.top))+") ",1),u("p",null," 左下: ("+g(Math.round(t.left))+", "+g(Math.round(t.top+t.height))+") ",1),u("p",null," 右下: ("+g(Math.round(t.left+t.width))+", "+g(Math.round(t.top+t.height))+") ",1)]),u("button",{class:"clear-button",onClick:i},"清除选择")])):b("",!0)]))}},ge=A(he,[["__scopeId","data-v-e1376212"]]),fe={class:"container-layout"},_e={class:"main-content"},ye={key:0,class:"loading-container"},Me={key:1,class:"result-section"},be={__name:"DynamicsAnalysisView",setup(x){const l=M({startMonth:"",endMonth:"",grad_forecast_month:1,grad_month:"",grad_lat_lon:"",grad_type:"sum",x1:null,y1:null,x2:null,y2:null}),y=M([]),c=M(!1),r=M(!1),m=M(null),v=M({x:null,y:null}),o=M({x:null,y:null});Y([v,o],([n,e])=>{l.value.x1=n.y,l.value.y1=n.x,l.value.x2=e.y,l.value.y2=e.x},{immediate:!0,deep:!0}),Y([()=>l.value.endMonth,()=>l.value.grad_forecast_month],([n,e])=>{if(n&&e){const i=new Date(n.substring(0,4),parseInt(n.substring(4))-1);i.setMonth(i.getMonth()+e),l.value.grad_month=String(i.getMonth()+1).padStart(2,"0")}else l.value.grad_month=""});const t=async()=>{if(m.value)try{const n=await W(m.value);n.success&&n.status==="COMPLETED"?(y.value=n.data.images,c.value=!0,$.success(n.message||"分析完成"),r.value=!1,m.value=null):n.status==="IN_PROGRESS"?console.log("Task not completed yet, continuing polling..."):n.status==="FAILED"&&(console.error("分析任务失败:",n.message),r.value=!1,c.value=!1,$.error(n.message||"分析任务失败"),m.value=null)}catch(n){console.error("轮询分析结果出错:",n),r.value=!1,c.value=!1,$.error("获取分析结果失败"),m.value=null}},k=async()=>{if(!l.value.startMonth||!l.value.endMonth||!l.value.grad_month||!l.value.grad_forecast_month){$.error("请填写完整的分析参数");return}try{r.value=!0,c.value=!1;const n=await K(l.value.startMonth,l.value.endMonth,l.value.grad_type,l.value.grad_month,l.value.x1,l.value.y1,l.value.x2,l.value.y2);if(n.success)m.value=n.data.task_id;else{r.value=!1,$.error(n.message||"提交分析请求失败");return}const e=setInterval(async()=>{await t(),r.value||clearInterval(e)},2e3)}catch(n){c.value=!1,r.value=!1,$.error("提交分析请求失败，请重试"),console.error("Analysis error:",n)}};return G(()=>{m.value&&(m.value=null)}),(n,e)=>{const i=Z,a=H,s=T,V=Q,I=J,R=B,F=z,N=q;return _(),f("div",fe,[u("div",_e,[d(N,{class:"box-card"},{default:h(()=>[d(F,{model:l.value,onSubmit:U(k,["prevent"]),class:"analysis-form"},{default:h(()=>[d(a,{label:"开始月份"},{default:h(()=>[d(i,{modelValue:l.value.startMonth,"onUpdate:modelValue":e[0]||(e[0]=p=>l.value.startMonth=p),type:"month",placeholder:"选择开始月份",format:"YYYY-MM","value-format":"YYYYMM"},null,8,["modelValue"])]),_:1}),d(a,{label:"结束月份"},{default:h(()=>[d(i,{modelValue:l.value.endMonth,"onUpdate:modelValue":e[1]||(e[1]=p=>l.value.endMonth=p),type:"month",placeholder:"选择结束月份",format:"YYYY-MM","value-format":"YYYYMM"},null,8,["modelValue"])]),_:1}),d(a,{label:"预报提前期"},{default:h(()=>[d(s,{modelValue:l.value.grad_forecast_month,"onUpdate:modelValue":e[2]||(e[2]=p=>l.value.grad_forecast_month=p),min:1,placeholder:"请输入提前期（月）"},null,8,["modelValue"])]),_:1}),d(a,{label:"目标月份"},{default:h(()=>[d(i,{modelValue:l.value.grad_month,"onUpdate:modelValue":e[3]||(e[3]=p=>l.value.grad_month=p),type:"month",placeholder:"目标月份由数据范围和预报提前期决定",format:"MM","value-format":"MM",disabled:""},null,8,["modelValue"])]),_:1}),d(a,{label:"分析范围"},{default:h(()=>[d(ge,{topLeft:v.value,"onUpdate:topLeft":e[4]||(e[4]=p=>v.value=p),bottomRight:o.value,"onUpdate:bottomRight":e[5]||(e[5]=p=>o.value=p)},null,8,["topLeft","bottomRight"])]),_:1}),d(a,{label:"分析目标"},{default:h(()=>[d(I,{modelValue:l.value.grad_type,"onUpdate:modelValue":e[6]||(e[6]=p=>l.value.grad_type=p)},{default:h(()=>[d(V,{value:"sum"},{default:h(()=>e[7]||(e[7]=[w("海冰面积")])),_:1}),d(V,{value:"variation"},{default:h(()=>e[8]||(e[8]=[w("海冰变化")])),_:1})]),_:1},8,["modelValue"])]),_:1}),d(a,null,{default:h(()=>[d(R,{type:"primary",loading:r.value,onClick:k},{default:h(()=>[w(g(r.value?"分析中...":"提交分析"),1)]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"]),r.value?(_(),f("div",ye,[d(X)])):b("",!0),!r.value&&c.value?(_(),f("div",Me,[d(de,{images:y.value,class:"full-width"},null,8,["images"])])):b("",!0)]),_:1})])])}}},Ye=A(be,[["__scopeId","data-v-c2285b4d"]]);export{Ye as default};
